
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.5.6
// @description  
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

function Ve(e,t,o){const n=t,s=Object.getOwnPropertyNames(n);for(let i=0;i<s.length;i+=1){const r=Object.getOwnPropertyDescriptor(n,s[i]);r&&typeof r.value=="function"&&Object.defineProperty(e,s[i],{...r,value:r.value.bind(o)})}}function z(e,t,o){let n=Object.getPrototypeOf(t);for(;n!=null;)Ve(e,n,o),n=Object.getPrototypeOf(n)}function E(e,t){const o=t,n=Object.getOwnPropertyNames(o);for(let s=0;s<n.length;s+=1){const i=Object.getOwnPropertyDescriptor(o,n[s]);i&&Object.defineProperty(e.prototype,n[s],i)}}function S(e,t){const o=Object.getOwnPropertyNames(t);for(let n=0;n<o.length;n+=1){const s=Object.getOwnPropertyDescriptor(t,o[n]);s&&typeof s.value=="function"&&Object.defineProperty(e,o[n],{...s,value:s.value.bind(t)})}}class te extends MessageChannel{}E(te,MessageChannel.prototype);const $e=Symbol;function M(e){return $e(e)}S(M,Symbol);E(M,Symbol.prototype);class k extends Object{}S(k,Object);E(k,Object.prototype);class ye extends Map{}E(ye,Map.prototype);class I extends Array{}S(I,Array);E(I,Array.prototype);class x extends Promise{}S(x,Promise);E(x,Promise.prototype);class R extends Error{}E(R,Error.prototype);const q=Object.create(null);S(q,Math);const _e=Proxy;function ne(e,t){return new _e(e,t)}ne.revocable=Proxy.revocable.bind(Proxy);const ze=(e,t)=>e===t,fe={equals:ze};let ve=Le;const N={},U=1,V=2,Qe={owned:null,cleanups:null,context:null,owner:null};var y=null;let F=null,g=null,T=null,m=null,L=null,oe=0;function d(e,t){t=t?k.assign({},fe,t):fe;const o={value:e,observers:null,observerSlots:null,pending:N,comparator:t.equals||void 0},n=s=>(typeof s=="function"&&(s=s(o.pending!==N?o.pending:o.value)),se(o,s));return[qe.bind(o),n]}function p(e,t,o){ve=tt;const n=Ze(e,t,!1,U);n.user=!0,L?L.push(n):re(n)}function Xe(e){if(T)return e();let t;const o=T=[];try{t=e()}finally{T=null}return Ee(()=>{for(let n=0;n<o.length;n+=1){const s=o[n];if(s.pending!==N){const i=s.pending;s.pending=N,se(s,i)}}},!1),t}function Ye(e){let t,o=g;return g=null,t=e(),g=o,t}function v(e){return y===null||(y.cleanups===null?y.cleanups=[e]:y.cleanups.push(e)),e}function qe(){const e=F;if(this.sources&&(this.state||e)){const t=m;m=null,this.state===U||e?re(this):$(this),m=t}if(g){const t=this.observers?this.observers.length:0;g.sources?(g.sources.push(this),g.sourceSlots.push(t)):(g.sources=[this],g.sourceSlots=[t]),this.observers?(this.observers.push(g),this.observerSlots.push(g.sources.length-1)):(this.observers=[g],this.observerSlots=[g.sources.length-1])}return this.value}function se(e,t,o){if(T)return e.pending===N&&T.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let n=!1;return e.value=t,e.observers&&e.observers.length&&Ee(()=>{for(let s=0;s<e.observers.length;s+=1){const i=e.observers[s];n&&F.disposed.has(i),(n&&!i.tState||!n&&!i.state)&&(i.pure?m.push(i):L.push(i),i.observers&&Se(i)),n||(i.state=U)}if(m.length>1e6)throw m=[],new R},!1),t}function re(e){if(!e.fn)return;ke(e);const t=y,o=g,n=oe;g=y=e,Je(e,e.value,n),g=o,y=t}function Je(e,t,o){let n;try{n=e.fn(t)}catch(s){Ce(s)}(!e.updatedAt||e.updatedAt<=o)&&(e.observers&&e.observers.length?se(e,n):e.value=n,e.updatedAt=o)}function Ze(e,t,o,n=U,s){const i={fn:e,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:y,context:null,pure:o};return y===null||y!==Qe&&(y.owned?y.owned.push(i):y.owned=[i]),i}function W(e){const t=F;if(e.state===0||t)return;if(e.state===V||t)return $(e);if(e.suspense&&Ye(e.suspense.inFallback))return e.suspense.effects.push(e);const o=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<oe);)(e.state||t)&&o.push(e);for(let n=o.length-1;n>=0;n--)if(e=o[n],e.state===U||t)re(e);else if(e.state===V||t){const s=m;m=null,$(e,o[0]),m=s}}function Ee(e,t){if(m)return e();let o=!1;t||(m=[]),L?o=!0:L=[],oe++;try{const n=e();return et(o),n}catch(n){Ce(n)}finally{m=null,o||(L=null)}}function et(e){m&&(Le(m),m=null),!e&&(L.length?Xe(()=>{ve(L),L=null}):L=null)}function Le(e){for(let t=0;t<e.length;t++)W(e[t])}function tt(e){let t,o=0;for(t=0;t<e.length;t++){const s=e[t];s.user?e[o++]=s:W(s)}const n=e.length;for(t=0;t<o;t++)W(e[t]);for(t=n;t<e.length;t++)W(e[t])}function $(e,t){const o=F;e.state=0;for(let n=0;n<e.sources.length;n+=1){const s=e.sources[n];s.sources&&(s.state===U||o?s!==t&&W(s):(s.state===V||o)&&$(s,t))}}function Se(e){const t=F;for(let o=0;o<e.observers.length;o+=1){const n=e.observers[o];(!n.state||t)&&(n.state=V,n.pure?m.push(n):L.push(n),n.observers&&Se(n))}}function ke(e){let t;if(e.sources)for(;e.sources.length;){const o=e.sources.pop(),n=e.sourceSlots.pop(),s=o.observers;if(s&&s.length){const i=s.pop(),r=o.observerSlots.pop();n<s.length&&(i.sourceSlots[r]=n,s[n]=i,o.observerSlots[n]=r)}}if(e.owned){for(t=0;t<e.owned.length;t++)ke(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function Ce(e){throw e}const u={get readyState(){return document.readyState},get pointerLockElement(){return document.pointerLockElement}};z(u,document,document);const _={};z(_,console,console);S(_,console);const nt=_.log.bind(_);class ie{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new ie(...this.argsScope,...t)}log(...t){nt(...this.argsScope,...t)}}function O(...e){return new ie("[Krunker Qoli]",...e)}const ot=O("[documentState]"),[H,pe]=d(!1);u.readyState!=="complete"?u.addEventListener("readystatechange",function e(){u.readyState==="complete"&&(u.removeEventListener("readystatechange",e),ot.log("document readyState complete event received, setting state true"),pe(!0))}):pe(!0);function st(){const[e,t]=d(u.readyState),o=()=>u.readyState==="loading",n=()=>u.readyState==="interactive",s=()=>u.readyState==="complete",[i,r]=d(o()||n()||s()),[l,a]=d(n()||s()),[c,h]=d(s());return u.addEventListener("readystatechange",function b(){t(u.readyState),r(o()||n()||s()),a(n()||s()),h(s()),s()&&u.removeEventListener("readystatechange",b)}),{documentReadyState:e,isDocumentAtLeastLoading:i,isDocumentAtLeastInteractive:l,isDocumentAtLeastComplete:c}}const[Qt,rt]=d(!1),[it,at]=d(!1),[Pe,ct]=d(!1),[lt,ut]=d(!1);class J extends MutationObserver{}E(J,MutationObserver.prototype);class dt extends J{constructor(){super(...arguments),this.observe=J.prototype.observe}}function ft(e){return new dt(t=>{t.forEach(o=>{o.type==="attributes"&&o.attributeName==="style"&&e(o.target.style)})})}function Q(e){return ft(t=>{const o=t.display==="block";e(o)})}const X={attributes:!0,attributeFilter:["style"]},Y=O("[adPopupDismisser]");function pt(){Y.log("initAdPopupDismisser");const[e,t]=d(!1),o=Q(t);p(()=>{if(!H())return;Y.log("document readyState complete, adding observer");const n=u.getElementById("popupHolder");n&&(t(n.style.display==="block"),o.observe(n,X),v(o.disconnect.bind(o)))}),p(()=>{!it()||(Y.log("isAdPopupActive effect",e()),e()&&u.getElementById("popupBack")?.click())})}class Ie extends KeyboardEvent{}E(Ie,KeyboardEvent.prototype);function Re(){const[e,t]=d(!1),o=Q(t);return p(()=>{if(!H())return;const n=u.getElementById("inGameUI");n&&(t(n.style.display==="block"),o.observe(n,X),v(o.disconnect.bind(o)))}),e}const ge=Ie,j=O("[autoReload]");function gt(){j.log("initAutoReload");const e=Re(),[t,o]=d(!1),n=Q(o);p(()=>{if(!H())return;j.log("document readyState complete, adding observer");const r=u.getElementById("reloadMsg");r&&(o(r.style.display==="block"),n.observe(r,X),v(n.disconnect.bind(n)))});const[s,i]=d(!1);p(()=>{if(!Pe()||!t())return;j.log("pressing down reload button");const r=I.from(u.getElementsByTagName("canvas")).pop(),l={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new ge("keydown",l)),i(!0)}),p(()=>{if(!s()||!e()||t())return;j.log("releasing reload button");const r=I.from(u.getElementsByTagName("canvas")).pop(),l={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new ge("keyup",l))})}class Oe extends MouseEvent{}E(Oe,MouseEvent.prototype);const f={opener:window.opener,location:{get href(){return window.location.href},set href(e){window.location.href=e}}};z(f,window,window);z(f.location,window.location,window.location);S(f.location,window.location);S(f,window);function mt(){const[e,t]=d(u.hasFocus()),o=()=>t(!0),n=()=>t(!1);return f.addEventListener("focus",o),f.addEventListener("blur",n),v(()=>{f.removeEventListener("focus",o),f.removeEventListener("blur",n)}),e}function ht(){const[e,t]=d(!1);function o(){t(!!u.pointerLockElement)}return p(()=>{!H()||(u.addEventListener("pointerlockchange",o),v(()=>{u.removeEventListener("pointerlockchange",o)}))}),e}function bt(){const[e,t]=d(!1),o=Q(t);return p(()=>{if(!H())return;const n=u.getElementById("killCardHolder");n&&(t(n.style.display==="block"),o.observe(n,X),v(o.disconnect.bind(o)))}),e}let Ae=()=>({events:{},emit(e,...t){let o=this.events[e]||[];for(let n=0,s=o.length;n<s;n++)o[n](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter(o=>t!==o)}}});function Me(e){return{on:e.on.bind(e)}}const wt=Function.prototype.apply.apply.bind(Function.prototype.apply);function yt(e){return typeof e!="object"||e==null?!1:"stack"in e}function ae(e,t,o){const n=O("[createFunctionProxy]",e,t,o);return n.log("creating function proxy"),new ne(e,{apply(s,i,r){const l=n.createScopedLogger("[apply]",s,i,r);try{t?.(...r)}catch(c){l.log("beforeCallback error",c)}let a;try{a=wt(s,[i,r])}catch(c){throw l.log("EXCEPTION",c),yt(c)&&(c.stack.includes("Object.apply")?c.stack=c.stack.replace(/\n.*Object\.apply.*/,""):c.stack.includes("apply@")&&(c.stack=c.stack.replace(/.*apply@.*\n/,""))),l.log("EXCEPTION before rethrow",c),c}try{o?.(...r)}catch(c){l.log("afterCallback error",c)}return a}})}const xe=Ae(),vt=document.exitPointerLock;document.exitPointerLock=ae(vt,void 0,()=>xe.emit("calledExitPointerLock"));var Et=Me(xe);const me=Oe,Ue=O("[fastRespawn]");function Lt(){Ue.log("trying to activate game");const e=I.from(u.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new me("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new me("mouseup",{bubbles:!0,cancelable:!0}))}function St(){Ue.log("initFastRespawn");const e=bt(),t=Re(),o=ht(),n=mt(),[s,i]=d(!1),r=Et.on("calledExitPointerLock",()=>{o()&&i(!0)});v(()=>{r()}),p(()=>{o()&&i(!1)}),p(()=>{!Pe()||!n()||!s()||o()||t()||!e()||(i(!1),Lt())})}class B extends URL{}S(B,URL);E(B,URL.prototype);class ce extends WeakMap{}S(ce,WeakMap);E(ce,WeakMap.prototype);class le extends Number{}S(le,Number);E(le,Number.prototype);const De=M("Comlink.proxy"),kt=M("Comlink.endpoint"),Ct=M("Comlink.releaseProxy"),Z=M("Comlink.thrown"),Te=e=>typeof e=="object"&&e!==null||typeof e=="function",Pt={canHandle:e=>Te(e)&&e[De],serialize(e){const{port1:t,port2:o}=new te;return Ne(e,t),[o,[o]]},deserialize(e){return e.start(),He(e)}},It={canHandle:e=>Te(e)&&Z in e,serialize({value:e}){let t;return e instanceof R?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?k.assign(new R(e.value.message),e.value):e.value}},We=new ye([["proxy",Pt],["throw",It]]);function Ne(e,t=self){t.addEventListener("message",function o(n){if(!n||!n.data)return;const{id:s,type:i,path:r}=k.assign({path:[]},n.data),l=(n.data.argumentList||[]).map(P);let a;try{const c=r.slice(0,-1).reduce((b,D)=>b[D],e),h=r.reduce((b,D)=>b[D],e);switch(i){case"GET":a=h;break;case"SET":c[r.slice(-1)[0]]=P(n.data.value),a=!0;break;case"APPLY":a=h.apply(c,l);break;case"CONSTRUCT":{const b=new h(...l);a=Ge(b)}break;case"ENDPOINT":{const{port1:b,port2:D}=new te;Ne(e,D),a=At(b,[b])}break;case"RELEASE":a=void 0;break;default:return}}catch(c){a={value:c,[Z]:0}}x.resolve(a).catch(c=>({value:c,[Z]:0})).then(c=>{const[h,b]=ue(c);t.postMessage(k.assign(k.assign({},h),{id:s}),b),i==="RELEASE"&&(t.removeEventListener("message",o),Fe(t))})}),t.start&&t.start()}function Rt(e){return e.constructor.name==="MessagePort"}function Fe(e){Rt(e)&&e.close()}function He(e,t){return ee(e,[],t)}function K(e){if(e)throw new R("Proxy has been released and is not useable")}function ee(e,t=[],o=function(){}){let n=!1;const s=new ne(o,{get(i,r){if(K(n),r===Ct)return()=>A(e,{type:"RELEASE",path:t.map(l=>l.toString())}).then(()=>{Fe(e),n=!0});if(r==="then"){if(t.length===0)return{then:()=>s};const l=A(e,{type:"GET",path:t.map(a=>a.toString())}).then(P);return l.then.bind(l)}return ee(e,[...t,r])},set(i,r,l){K(n);const[a,c]=ue(l);return A(e,{type:"SET",path:[...t,r].map(h=>h.toString()),value:a},c).then(P)},apply(i,r,l){K(n);const a=t[t.length-1];if(a===kt)return A(e,{type:"ENDPOINT"}).then(P);if(a==="bind")return ee(e,t.slice(0,-1));const[c,h]=he(l);return A(e,{type:"APPLY",path:t.map(b=>b.toString()),argumentList:c},h).then(P)},construct(i,r){K(n);const[l,a]=he(r);return A(e,{type:"CONSTRUCT",path:t.map(c=>c.toString()),argumentList:l},a).then(P)}});return s}function Ot(e){return I.prototype.concat.apply([],e)}function he(e){const t=e.map(ue);return[t.map(o=>o[0]),Ot(t.map(o=>o[1]))]}const Be=new ce;function At(e,t){return Be.set(e,t),e}function Ge(e){return k.assign(e,{[De]:!0})}function Mt(e,t=self,o="*"){return{postMessage:(n,s)=>e.postMessage(n,o,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function ue(e){for(const[t,o]of We)if(o.canHandle(e)){const[n,s]=o.serialize(e);return[{type:"HANDLER",name:t,value:n},s]}return[{type:"RAW",value:e},Be.get(e)||[]]}function P(e){switch(e.type){case"HANDLER":return We.get(e.name).deserialize(e.value);case"RAW":return e.value}}function A(e,t,o){return new x(n=>{const s=xt();e.addEventListener("message",function i(r){!r.data||!r.data.id||r.data.id!==s||(e.removeEventListener("message",i),n(r.data))}),e.start&&e.start(),e.postMessage(k.assign({id:s},t),o)})}function xt(){return new I(4).fill(0).map(()=>q.floor(q.random()*le.MAX_SAFE_INTEGER).toString(16)).join("-")}const Ut="0.5.6",Dt=Ut;function Tt(...e){const t=Mt(...e),o={},n=t.addEventListener.bind(t);t.addEventListener=(...r)=>{const l=o[r[0]];return l?l.push(r[1]):o[r[0]]=[r[1]],n(...r)};const s=t.removeEventListener.bind(t);t.removeEventListener=(...r)=>{const l=o[r[0]];return l&&(o[r[0]]=l.filter(a=>a!==r[1])),s(...r)};function i(){k.keys(o).forEach(r=>{o[r].forEach(l=>{s(r,l)})})}return{unsubscribeAll:i,...t}}const Wt=O("[useRemoveClosedWindows]");function Nt(e,t){const o=setInterval(()=>{const n=e();n&&n.closed&&(Wt.log("is closed",e()),t())},1e3);v(()=>clearInterval(o))}const G=Ae(),Ft=window.history.pushState;window.history.pushState=ae(Ft,void 0,()=>G.emit("locationChanged"));const Ht=window.history.replaceState;window.history.replaceState=ae(Ht,void 0,()=>G.emit("locationChanged"));window.addEventListener("hashchange",()=>G.emit("locationChanged"));window.addEventListener("popstate",()=>G.emit("locationChanged"));var Bt=Me(G);function je(){const[e,t]=d(f.location.href);return Bt.on("locationChanged",()=>{t(f.location.href)}),e}const w=O("[Settings window communication]"),Ke=B,de=new Ke("https://woyken.github.io/krunker-qoli"),C={};f.addEventListener("message",e=>{e.origin===de.origin&&e.stopImmediatePropagation(),C.message?.forEach(t=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function Gt(e){w.log("settingsUpdatedCallback",e),ct(e.enabledFastRespawn),at(e.enabledAdPopupRemoval),rt(e.enabledAutoReload),ut(e.enabledWindowManager)}function be(e,t){return new x((o,n)=>{setTimeout(()=>{n(new R("Promise timed out"))},t),e.then(o,n)})}let we=!1;function jt(){const[e,t]=d();if(f.opener)t(f.opener);else{const{isDocumentAtLeastInteractive:o}=st();p(()=>{if(we||!o())return;w.log("opening new settings window");const n=f.open(new Ke("#userScriptSettings",de).href,"settingsWindow","width=400,height=450");if(we=!0,!n)throw alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new R("Failed to open settings window");t(n),v(()=>{w.log("onCleanup, closing settings window",n),n.close()});function s(){w.log("handleBeforeUnload, closing settings window",n),n?.close()}f.addEventListener("beforeunload",s),v(()=>f.removeEventListener("beforeunload",s)),Nt(e,t)})}return e}async function Kt(e){const[t,o]=d("connecting");v(()=>o("disposed"));const n=Tt(e,{addEventListener(a,c){C[a]?C[a].push(c):C[a]=[c]},removeEventListener(a,c){C[a]&&(C[a]=C[a].filter(h=>h!==c))}},"*"),s=He(n);v(()=>n.unsubscribeAll());function i(){s.scriptUnloading().catch(a=>w.log("on beforeUnload error",a))}f.addEventListener("beforeunload",i),v(()=>f.removeEventListener("beforeunload",i));const r=je();p(()=>{s.scriptLocationChanged(r())});const l=new x(a=>{w.log("waiting for settings window");const c=setInterval(()=>{w.log("checking for settings window"),be(s.ping,200).then(()=>{clearInterval(c),a()}).catch(h=>{w.log("[onSettingsWindowAvailablePromise]","error",h)})},200)});return be(l,6e4).then(()=>{s.onUnloadPromise.then(()=>{w.log("settings window unloaded"),o("disposed")}),w.log("settings window available"),o("available")}).catch(a=>{w.log("settings window connection error",a),o("error")}),p(()=>{w.log("settings connection state changed",t()),t()==="available"&&(w.log("registering for remote settings callbacks"),s.registerSettingsCallback(Dt,Ge(Gt)))}),{state:t,remoteExposedSettings:s}}function Vt(){const e=jt(),[t,o]=d();return p(()=>{const n=e();if(!n)return;const s=Kt(n);o(s)}),t}function $t(){p(()=>{if(!lt()||f.opener)return;const e=f.location.href,t=new B(`#windowManager?redirectKrunkerUrl=${e}`,de);f.open(t,"_self")})}function _t(){const[e,t]=d(!1),o=je();return p(()=>{new B(o()).searchParams.get("game")&&t(!0)}),e}function zt(){const e=_t();p(()=>{!e()||(pt(),St(),gt(),$t(),Vt())})}zt();
