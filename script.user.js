
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.5.4
// @description  
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

const Ce=(e,t)=>e===t,q={equals:Ce};let oe=ie;const U={},C=1,W=2,Pe={owned:null,cleanups:null,context:null,owner:null};var b=null;let M=null,f=null,R=null,g=null,y=null,j=0;function u(e,t){t=t?Object.assign({},q,t):q;const n={value:e,observers:null,observerSlots:null,pending:U,comparator:t.equals||void 0},s=o=>(typeof o=="function"&&(o=o(n.pending!==U?n.pending:n.value)),_(n,o));return[Ae.bind(n),s]}function d(e,t,n){oe=De;const s=Me(e,t,!1,C);s.user=!0,y?y.push(s):$(s)}function Ie(e){if(R)return e();let t;const n=R=[];try{t=e()}finally{R=null}return re(()=>{for(let s=0;s<n.length;s+=1){const o=n[s];if(o.pending!==U){const i=o.pending;o.pending=U,_(o,i)}}},!1),t}function Re(e){let t,n=f;return f=null,t=e(),f=n,t}function E(e){return b===null||(b.cleanups===null?b.cleanups=[e]:b.cleanups.push(e)),e}function Ae(){const e=M;if(this.sources&&(this.state||e)){const t=g;g=null,this.state===C||e?$(this):F(this),g=t}if(f){const t=this.observers?this.observers.length:0;f.sources?(f.sources.push(this),f.sourceSlots.push(t)):(f.sources=[this],f.sourceSlots=[t]),this.observers?(this.observers.push(f),this.observerSlots.push(f.sources.length-1)):(this.observers=[f],this.observerSlots=[f.sources.length-1])}return this.value}function _(e,t,n){if(R)return e.pending===U&&R.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let s=!1;return e.value=t,e.observers&&e.observers.length&&re(()=>{for(let o=0;o<e.observers.length;o+=1){const i=e.observers[o];s&&M.disposed.has(i),(s&&!i.tState||!s&&!i.state)&&(i.pure?g.push(i):y.push(i),i.observers&&ae(i)),s||(i.state=C)}if(g.length>1e6)throw g=[],new Error},!1),t}function $(e){if(!e.fn)return;ce(e);const t=b,n=f,s=j;f=b=e,Ue(e,e.value,s),f=n,b=t}function Ue(e,t,n){let s;try{s=e.fn(t)}catch(o){le(o)}(!e.updatedAt||e.updatedAt<=n)&&(e.observers&&e.observers.length?_(e,s):e.value=s,e.updatedAt=n)}function Me(e,t,n,s=C,o){const i={fn:e,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:b,context:null,pure:n};return b===null||b!==Pe&&(b.owned?b.owned.push(i):b.owned=[i]),i}function A(e){const t=M;if(e.state===0||t)return;if(e.state===W||t)return F(e);if(e.suspense&&Re(e.suspense.inFallback))return e.suspense.effects.push(e);const n=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<j);)(e.state||t)&&n.push(e);for(let s=n.length-1;s>=0;s--)if(e=n[s],e.state===C||t)$(e);else if(e.state===W||t){const o=g;g=null,F(e,n[0]),g=o}}function re(e,t){if(g)return e();let n=!1;t||(g=[]),y?n=!0:y=[],j++;try{const s=e();return Te(n),s}catch(s){le(s)}finally{g=null,n||(y=null)}}function Te(e){g&&(ie(g),g=null),!e&&(y.length?Ie(()=>{oe(y),y=null}):y=null)}function ie(e){for(let t=0;t<e.length;t++)A(e[t])}function De(e){let t,n=0;for(t=0;t<e.length;t++){const o=e[t];o.user?e[n++]=o:A(o)}const s=e.length;for(t=0;t<n;t++)A(e[t]);for(t=s;t<e.length;t++)A(e[t])}function F(e,t){const n=M;e.state=0;for(let s=0;s<e.sources.length;s+=1){const o=e.sources[s];o.sources&&(o.state===C||n?o!==t&&A(o):(o.state===W||n)&&F(o,t))}}function ae(e){const t=M;for(let n=0;n<e.observers.length;n+=1){const s=e.observers[n];(!s.state||t)&&(s.state=W,s.pure?g.push(s):y.push(s),s.observers&&ae(s))}}function ce(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),s=e.sourceSlots.pop(),o=n.observers;if(o&&o.length){const i=o.pop(),r=n.observerSlots.pop();s<o.length&&(i.sourceSlots[r]=s,o[s]=i,n.observerSlots[s]=r)}}if(e.owned){for(t=0;t<e.owned.length;t++)ce(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function le(e){throw e}const m={getElementById:document.getElementById.bind(document),getElementsByClassName:document.getElementsByClassName.bind(document),getElementsByTagName:document.getElementsByTagName.bind(document),addEventListener:document.addEventListener.bind(document),removeEventListener:document.removeEventListener.bind(document),createEvent:document.createEvent.bind(document),hasFocus:document.hasFocus.bind(document)},Oe=console.log.bind(console);class z{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new z(...this.argsScope,...t)}log(...t){Oe(...this.argsScope,...t)}}function P(...e){return new z("[Krunker Qoli]",...e)}const xe=P("[documentState]"),[T,J]=u(!1);document.readyState!=="complete"?m.addEventListener("readystatechange",function e(){document.readyState==="complete"&&(m.removeEventListener("readystatechange",e),xe.log("document readyState complete event received, setting state true"),J(!0))}):J(!0);function We(){const[e,t]=u(document.readyState),n=()=>document.readyState==="loading",s=()=>document.readyState==="interactive",o=()=>document.readyState==="complete",[i,r]=u(n()||s()||o()),[c,a]=u(s()||o()),[l,p]=u(o());return m.addEventListener("readystatechange",function h(){t(document.readyState),r(n()||s()||o()),a(s()||o()),p(o()),o()&&m.removeEventListener("readystatechange",h)}),{documentReadyState:e,isDocumentAtLeastLoading:i,isDocumentAtLeastInteractive:c,isDocumentAtLeastComplete:l}}const[Lt,Fe]=u(!1),[Ne,Be]=u(!1),[ue,He]=u(!1),[Ge,Ke]=u(!1);class Ve extends MutationObserver{constructor(){super(...arguments),this.observe=MutationObserver.prototype.observe}}function je(e){return new Ve(t=>{t.forEach(n=>{n.type==="attributes"&&n.attributeName==="style"&&e(n.target.style)})})}function N(e){return je(t=>{const n=t.display==="block";e(n)})}const B={attributes:!0,attributeFilter:["style"]},H=P("[adPopupDismisser]");function _e(){H.log("initAdPopupDismisser");const[e,t]=u(!1),n=N(t);d(()=>{if(!T())return;H.log("document readyState complete, adding observer");const s=m.getElementById("popupHolder");s&&(t(s.style.display==="block"),n.observe(s,B),E(n.disconnect.bind(n)))}),d(()=>{!Ne()||(H.log("isAdPopupActive effect",e()),e()&&m.getElementById("popupBack")?.click())})}function de(){const[e,t]=u(!1),n=N(t);return d(()=>{if(!T())return;const s=m.getElementById("inGameUI");s&&(t(s.style.display==="block"),n.observe(s,B),E(n.disconnect.bind(n)))}),e}const G={arrayFrom:Array.from.bind(Array)},Z=KeyboardEvent,O=P("[autoReload]");function $e(){O.log("initAutoReload");const e=de(),[t,n]=u(!1),s=N(n);d(()=>{if(!T())return;O.log("document readyState complete, adding observer");const r=m.getElementById("reloadMsg");r&&(n(r.style.display==="block"),s.observe(r,B),E(s.disconnect.bind(s)))});const[o,i]=u(!1);d(()=>{if(!ue()||!t())return;O.log("pressing down reload button");const r=G.arrayFrom(m.getElementsByTagName("canvas")).pop(),c={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new Z("keydown",c)),i(!0)}),d(()=>{if(!o()||!e()||t())return;O.log("releasing reload button");const r=G.arrayFrom(m.getElementsByTagName("canvas")).pop(),c={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new Z("keyup",c))})}const v={open:window.open.bind(window),addEventListener:window.addEventListener.bind(window),removeEventListener:window.removeEventListener.bind(window),setTimeout:window.setTimeout.bind(window),clearTimeout:window.clearTimeout.bind(window)};function ze(){const[e,t]=u(m.hasFocus()),n=()=>t(!0),s=()=>t(!1);return v.addEventListener("focus",n),v.addEventListener("blur",s),E(()=>{v.removeEventListener("focus",n),v.removeEventListener("blur",s)}),e}function Qe(){const[e,t]=u(!1);function n(){t(!!document.pointerLockElement)}return d(()=>{!T()||(m.addEventListener("pointerlockchange",n),E(()=>{m.removeEventListener("pointerlockchange",n)}))}),e}function Ye(){const[e,t]=u(!1),n=N(t);return d(()=>{if(!T())return;const s=m.getElementById("killCardHolder");s&&(t(s.style.display==="block"),n.observe(s,B),E(n.disconnect.bind(n)))}),e}let fe=()=>({events:{},emit(e,...t){let n=this.events[e]||[];for(let s=0,o=n.length;s<o;s++)n[s](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter(n=>t!==n)}}});function Q(e,t,n){return new Proxy(e,{apply(s,o,i){t?.(...i);const r=s.apply(o,i);return n?.(...i),r}})}const ge=fe(),Xe=document.exitPointerLock;document.exitPointerLock=Q(Xe,void 0,()=>ge.emit("calledExitPointerLock"));const ee=MouseEvent,pe=P("[fastRespawn]");function qe(){pe.log("trying to activate game");const e=G.arrayFrom(m.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new ee("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new ee("mouseup",{bubbles:!0,cancelable:!0}))}function Je(){pe.log("initFastRespawn");const e=Ye(),t=de(),n=Qe(),s=ze(),[o,i]=u(!1),r=ge.on("calledExitPointerLock",()=>{n()&&i(!0)});E(()=>{r()}),d(()=>{n()&&i(!1)}),d(()=>{!ue()||!s()||!o()||n()||t()||!e()||(i(!1),qe())})}const me=Symbol("Comlink.proxy"),Ze=Symbol("Comlink.endpoint"),et=Symbol("Comlink.releaseProxy"),K=Symbol("Comlink.thrown"),he=e=>typeof e=="object"&&e!==null||typeof e=="function",tt={canHandle:e=>he(e)&&e[me],serialize(e){const{port1:t,port2:n}=new MessageChannel;return be(e,t),[n,[n]]},deserialize(e){return e.start(),Ee(e)}},nt={canHandle:e=>he(e)&&K in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},we=new Map([["proxy",tt],["throw",nt]]);function be(e,t=self){t.addEventListener("message",function n(s){if(!s||!s.data)return;const{id:o,type:i,path:r}=Object.assign({path:[]},s.data),c=(s.data.argumentList||[]).map(S);let a;try{const l=r.slice(0,-1).reduce((h,I)=>h[I],e),p=r.reduce((h,I)=>h[I],e);switch(i){case"GET":a=p;break;case"SET":l[r.slice(-1)[0]]=S(s.data.value),a=!0;break;case"APPLY":a=p.apply(l,c);break;case"CONSTRUCT":{const h=new p(...c);a=Le(h)}break;case"ENDPOINT":{const{port1:h,port2:I}=new MessageChannel;be(e,I),a=rt(h,[h])}break;case"RELEASE":a=void 0;break;default:return}}catch(l){a={value:l,[K]:0}}Promise.resolve(a).catch(l=>({value:l,[K]:0})).then(l=>{const[p,h]=Y(l);t.postMessage(Object.assign(Object.assign({},p),{id:o}),h),i==="RELEASE"&&(t.removeEventListener("message",n),ve(t))})}),t.start&&t.start()}function st(e){return e.constructor.name==="MessagePort"}function ve(e){st(e)&&e.close()}function Ee(e,t){return V(e,[],t)}function x(e){if(e)throw new Error("Proxy has been released and is not useable")}function V(e,t=[],n=function(){}){let s=!1;const o=new Proxy(n,{get(i,r){if(x(s),r===et)return()=>k(e,{type:"RELEASE",path:t.map(c=>c.toString())}).then(()=>{ve(e),s=!0});if(r==="then"){if(t.length===0)return{then:()=>o};const c=k(e,{type:"GET",path:t.map(a=>a.toString())}).then(S);return c.then.bind(c)}return V(e,[...t,r])},set(i,r,c){x(s);const[a,l]=Y(c);return k(e,{type:"SET",path:[...t,r].map(p=>p.toString()),value:a},l).then(S)},apply(i,r,c){x(s);const a=t[t.length-1];if(a===Ze)return k(e,{type:"ENDPOINT"}).then(S);if(a==="bind")return V(e,t.slice(0,-1));const[l,p]=te(c);return k(e,{type:"APPLY",path:t.map(h=>h.toString()),argumentList:l},p).then(S)},construct(i,r){x(s);const[c,a]=te(r);return k(e,{type:"CONSTRUCT",path:t.map(l=>l.toString()),argumentList:c},a).then(S)}});return o}function ot(e){return Array.prototype.concat.apply([],e)}function te(e){const t=e.map(Y);return[t.map(n=>n[0]),ot(t.map(n=>n[1]))]}const ye=new WeakMap;function rt(e,t){return ye.set(e,t),e}function Le(e){return Object.assign(e,{[me]:!0})}function it(e,t=self,n="*"){return{postMessage:(s,o)=>e.postMessage(s,n,o),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function Y(e){for(const[t,n]of we)if(n.canHandle(e)){const[s,o]=n.serialize(e);return[{type:"HANDLER",name:t,value:s},o]}return[{type:"RAW",value:e},ye.get(e)||[]]}function S(e){switch(e.type){case"HANDLER":return we.get(e.name).deserialize(e.value);case"RAW":return e.value}}function k(e,t,n){return new Promise(s=>{const o=at();e.addEventListener("message",function i(r){!r.data||!r.data.id||r.data.id!==o||(e.removeEventListener("message",i),s(r.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:o},t),n)})}function at(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const ct="0.5.4",lt=ct;function ut(...e){const t=it(...e),n={},s=t.addEventListener.bind(t);t.addEventListener=(...r)=>{const c=n[r[0]];return c?c.push(r[1]):n[r[0]]=[r[1]],s(...r)};const o=t.removeEventListener.bind(t);t.removeEventListener=(...r)=>{const c=n[r[0]];return c&&(n[r[0]]=c.filter(a=>a!==r[1])),o(...r)};function i(){Object.keys(n).forEach(r=>{n[r].forEach(c=>{o(r,c)})})}return{unsubscribeAll:i,...t}}const dt=P("[useRemoveClosedWindows]");function ft(e,t){const n=setInterval(()=>{const s=e();s&&s.closed&&(dt.log("is closed",e()),t())},1e3);E(()=>clearInterval(n))}const D=fe(),gt=window.history.pushState;window.history.pushState=Q(gt,void 0,()=>D.emit("locationChanged"));const pt=window.history.replaceState;window.history.replaceState=Q(pt,void 0,()=>D.emit("locationChanged"));v.addEventListener("hashchange",()=>D.emit("locationChanged"));v.addEventListener("popstate",()=>D.emit("locationChanged"));function Se(){const[e,t]=u(window.location.href);return D.on("locationChanged",()=>{t(window.location.href)}),e}const w=P("[Settings window communication]"),ke=URL,X=new ke("https://woyken.github.io/krunker-qoli"),L={};v.addEventListener("message",e=>{e.origin===X.origin&&e.stopImmediatePropagation(),L.message?.forEach(t=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function mt(e){w.log("settingsUpdatedCallback",e),He(e.enabledFastRespawn),Be(e.enabledAdPopupRemoval),Fe(e.enabledAutoReload),Ke(e.enabledWindowManager)}function ne(e,t){return new Promise((n,s)=>{setTimeout(()=>{s(new Error("Promise timed out"))},t),e.then(n,s)})}let se=!1;function ht(){const[e,t]=u();if(window.opener)t(window.opener);else{const{isDocumentAtLeastInteractive:n}=We();d(()=>{if(se||!n())return;w.log("opening new settings window");const s=v.open(new ke("#userScriptSettings",X).href,"settingsWindow","width=400,height=450");if(se=!0,!s)throw alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new Error("Failed to open settings window");t(s),E(()=>{w.log("onCleanup, closing settings window",s),s.close()});function o(){w.log("handleBeforeUnload, closing settings window",s),s?.close()}v.addEventListener("beforeunload",o),E(()=>v.removeEventListener("beforeunload",o)),ft(e,t)})}return e}async function wt(e){const[t,n]=u("connecting");E(()=>n("disposed"));const s=ut(e,{addEventListener(a,l){L[a]?L[a].push(l):L[a]=[l]},removeEventListener(a,l){L[a]&&(L[a]=L[a].filter(p=>p!==l))}},"*"),o=Ee(s);E(()=>s.unsubscribeAll());function i(){o.scriptUnloading().catch(a=>w.log("on beforeUnload error",a))}v.addEventListener("beforeunload",i),E(()=>v.removeEventListener("beforeunload",i));const r=Se();d(()=>{o.scriptLocationChanged(r())});const c=new Promise(a=>{w.log("waiting for settings window");const l=setInterval(()=>{w.log("checking for settings window"),ne(o.ping,200).then(()=>{clearInterval(l),a()}).catch(p=>{w.log("[onSettingsWindowAvailablePromise]","error",p)})},200)});return ne(c,6e4).then(()=>{o.onUnloadPromise.then(()=>{w.log("settings window unloaded"),n("disposed")}),w.log("settings window available"),n("available")}).catch(a=>{w.log("settings window connection error",a),n("error")}),d(()=>{w.log("settings connection state changed",t()),t()==="available"&&(w.log("registering for remote settings callbacks"),o.registerSettingsCallback(lt,Le(mt)))}),{state:t,remoteExposedSettings:o}}function bt(){const e=ht(),[t,n]=u();return d(()=>{const s=e();if(!s)return;const o=wt(s);n(o)}),t}function vt(){d(()=>{if(!Ge()||window.opener)return;const e=window.location.href,t=new URL(`#windowManager?redirectKrunkerUrl=${e}`,X);v.open(t,"_self")})}function Et(){const[e,t]=u(!1),n=Se();return d(()=>{new URL(n()).searchParams.get("game")&&t(!0)}),e}function yt(){const e=Et();d(()=>{!e()||(_e(),Je(),$e(),vt(),bt())})}yt();
