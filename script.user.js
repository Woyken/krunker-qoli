
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.4.2
// @description  
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

const ke=(e,t)=>e===t,X={equals:ke};let ne=oe;const C={},y=1,O=2,Se={owned:null,cleanups:null,context:null,owner:null};var f=null;let R=null,c=null,P=null,u=null,m=null,_=0;function g(e,t){t=t?Object.assign({},X,t):X;const s={value:e,observers:null,observerSlots:null,pending:C,comparator:t.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.pending!==C?s.pending:s.value)),z(s,r));return[Ae.bind(s),n]}function h(e,t,s){ne=Te;const n=Re(e,t,!1,y),r=J&&ce(f,J.id);r&&(n.suspense=r),n.user=!0,m?m.push(n):$(n)}function Pe(e){if(P)return e();let t;const s=P=[];try{t=e()}finally{P=null}return re(()=>{for(let n=0;n<s.length;n+=1){const r=s[n];if(r.pending!==C){const o=r.pending;r.pending=C,z(r,o)}}},!1),t}function Ie(e){let t,s=c;return c=null,t=e(),c=s,t}function se(e){return f===null||(f.cleanups===null?f.cleanups=[e]:f.cleanups.push(e)),e}let J;function Ae(){const e=R;if(this.sources&&(this.state||e)){const t=u;u=null,this.state===y||e?$(this):D(this),u=t}if(c){const t=this.observers?this.observers.length:0;c.sources?(c.sources.push(this),c.sourceSlots.push(t)):(c.sources=[this],c.sourceSlots=[t]),this.observers?(this.observers.push(c),this.observerSlots.push(c.sources.length-1)):(this.observers=[c],this.observerSlots=[c.sources.length-1])}return this.value}function z(e,t,s){if(P)return e.pending===C&&P.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let n=!1;return e.value=t,e.observers&&e.observers.length&&re(()=>{for(let r=0;r<e.observers.length;r+=1){const o=e.observers[r];n&&R.disposed.has(o),(n&&!o.tState||!n&&!o.state)&&(o.pure?u.push(o):m.push(o),o.observers&&ie(o)),n||(o.state=y)}if(u.length>1e6)throw u=[],new Error},!1),t}function $(e){if(!e.fn)return;ae(e);const t=f,s=c,n=_;c=f=e,Ce(e,e.value,n),c=s,f=t}function Ce(e,t,s){let n;try{n=e.fn(t)}catch(r){le(r)}(!e.updatedAt||e.updatedAt<=s)&&(e.observers&&e.observers.length?z(e,n):e.value=n,e.updatedAt=s)}function Re(e,t,s,n=y,r){const o={fn:e,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:f,context:null,pure:s};return f===null||f!==Se&&(f.owned?f.owned.push(o):f.owned=[o]),o}function I(e){const t=R;if(e.state===0||t)return;if(e.state===O||t)return D(e);if(e.suspense&&Ie(e.suspense.inFallback))return e.suspense.effects.push(e);const s=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<_);)(e.state||t)&&s.push(e);for(let n=s.length-1;n>=0;n--)if(e=s[n],e.state===y||t)$(e);else if(e.state===O||t){const r=u;u=null,D(e,s[0]),u=r}}function re(e,t){if(u)return e();let s=!1;t||(u=[]),m?s=!0:m=[],_++;try{const n=e();return xe(s),n}catch(n){le(n)}finally{u=null,s||(m=null)}}function xe(e){u&&(oe(u),u=null),!e&&(m.length?Pe(()=>{ne(m),m=null}):m=null)}function oe(e){for(let t=0;t<e.length;t++)I(e[t])}function Te(e){let t,s=0;for(t=0;t<e.length;t++){const r=e[t];r.user?e[s++]=r:I(r)}const n=e.length;for(t=0;t<s;t++)I(e[t]);for(t=n;t<e.length;t++)I(e[t])}function D(e,t){const s=R;e.state=0;for(let n=0;n<e.sources.length;n+=1){const r=e.sources[n];r.sources&&(r.state===y||s?r!==t&&I(r):(r.state===O||s)&&D(r,t))}}function ie(e){const t=R;for(let s=0;s<e.observers.length;s+=1){const n=e.observers[s];(!n.state||t)&&(n.state=O,n.pure?u.push(n):m.push(n),n.observers&&ie(n))}}function ae(e){let t;if(e.sources)for(;e.sources.length;){const s=e.sources.pop(),n=e.sourceSlots.pop(),r=s.observers;if(r&&r.length){const o=r.pop(),i=s.observerSlots.pop();n<r.length&&(o.sourceSlots[i]=n,r[n]=o,s.observerSlots[n]=i)}}if(e.owned){for(t=0;t<e.owned.length;t++)ae(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function le(e){throw e}function ce(e,t){return e?e.context&&e.context[t]!==void 0?e.context[t]:ce(e.owner,t):void 0}const Me=console.log.bind(console);class Q{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new Q(...this.argsScope,...t)}log(...t){Me(...this.argsScope,...t)}}function x(...e){return new Q("[Krunker Qoli]",...e)}const Fe=x("[documentState]"),Ne=document.addEventListener.bind(document),Ue=document.removeEventListener.bind(document),[T,Z]=g(!1);document.readyState!=="complete"?Ne("readystatechange",function e(){document.readyState==="complete"&&(Ue("readystatechange",e),Fe.log("document readyState complete event received, setting state true"),Z(!0))}):Z(!0);const[pt,Oe]=g(!1),[De,We]=g(!1),[ue,Be]=g(!1),b={getElementById:document.getElementById.bind(document),getElementsByClassName:document.getElementsByClassName.bind(document),getElementsByTagName:document.getElementsByTagName.bind(document),addEventListener:document.addEventListener.bind(document),removeEventListener:document.removeEventListener.bind(document),createEvent:document.createEvent.bind(document),hasFocus:document.hasFocus.bind(document)};class Ge extends MutationObserver{constructor(){super(...arguments),this.observe=MutationObserver.prototype.observe}}function He(e){return new Ge(t=>{t.forEach(s=>{s.type==="attributes"&&s.attributeName==="style"&&e(s.target.style)})})}function W(e){return He(t=>{const s=t.display==="block";e(s)})}const B={attributes:!0,attributeFilter:["style"]},G=x("[adPopupDismisser]");function Ke(){G.log("initAdPopupDismisser");const[e,t]=g(!1),s=W(t);h(()=>{if(!T())return;G.log("document readyState complete, adding observer");const n=b.getElementById("popupHolder");n&&(t(n.style.display==="block"),s.observe(n,B))}),h(()=>{!De()||(G.log("isAdPopupActive effect",e()),e()&&b.getElementById("popupBack")?.click())})}function de(){const[e,t]=g(!1),s=W(t);return h(()=>{if(!T())return;const n=b.getElementById("inGameUI");n&&(t(n.style.display==="block"),s.observe(n,B))}),e}const H={arrayFrom:Array.from.bind(Array)},q=KeyboardEvent,M=x("[autoReload]");function Ve(){M.log("initAutoReload");const e=de(),[t,s]=g(!1),n=W(s);h(()=>{if(!T())return;M.log("document readyState complete, adding observer");const i=b.getElementById("reloadMsg");i&&(s(i.style.display==="block"),n.observe(i,B))});const[r,o]=g(!1);h(()=>{if(!ue()||!t())return;M.log("pressing down reload button");const i=H.arrayFrom(b.getElementsByTagName("canvas")).pop(),a={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};i?.dispatchEvent(new q("keydown",a)),o(!0)}),h(()=>{if(!r()||!e()||t())return;M.log("releasing reload button");const i=H.arrayFrom(b.getElementsByTagName("canvas")).pop(),a={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};i?.dispatchEvent(new q("keyup",a))})}const k={open:window.open.bind(window),addEventListener:window.addEventListener.bind(window),removeEventListener:window.removeEventListener.bind(window)};function je(){const[e,t]=g(b.hasFocus()),s=()=>t(!0),n=()=>t(!1);return k.addEventListener("focus",s),k.addEventListener("blur",n),se(()=>{k.removeEventListener("focus",s),k.removeEventListener("blur",n)}),e}function _e(){const[e,t]=g(!1);return h(()=>{!T()||b.addEventListener("pointerlockchange",()=>{t(!!document.pointerLockElement)})}),e}function ze(){const[e,t]=g(!1),s=W(t);return h(()=>{if(!T())return;const n=b.getElementById("killCardHolder");n&&(t(n.style.display==="block"),s.observe(n,B))}),e}let $e=()=>({events:{},emit(e,...t){let s=this.events[e]||[];for(let n=0,r=s.length;n<r;n++)s[n](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter(s=>t!==s)}}});function Qe(e,t,s){return new Proxy(e,{apply(n,r,o){t?.(...o);const i=n.apply(r,o);return s?.(...o),i}})}const fe=$e(),Ye=document.exitPointerLock;document.exitPointerLock=Qe(Ye,void 0,()=>fe.emit("calledExitPointerLock"));const ee=MouseEvent,pe=x("[fastRespawn]");function Xe(){pe.log("trying to activate game");const e=H.arrayFrom(b.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new ee("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new ee("mouseup",{bubbles:!0,cancelable:!0}))}function Je(){pe.log("initFastRespawn");const e=ze(),t=de(),s=_e(),n=je(),[r,o]=g(!1),i=fe.on("calledExitPointerLock",()=>{s()&&o(!0)});se(()=>{i()}),h(()=>{s()&&o(!1)}),h(()=>{!ue()||!n()||!r()||s()||t()||!e()||(o(!1),Xe())})}const ge=Symbol("Comlink.proxy"),Ze=Symbol("Comlink.endpoint"),qe=Symbol("Comlink.releaseProxy"),K=Symbol("Comlink.thrown"),me=e=>typeof e=="object"&&e!==null||typeof e=="function",et={canHandle:e=>me(e)&&e[ge],serialize(e){const{port1:t,port2:s}=new MessageChannel;return be(e,t),[s,[s]]},deserialize(e){return e.start(),Ee(e)}},tt={canHandle:e=>me(e)&&K in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},he=new Map([["proxy",et],["throw",tt]]);function be(e,t=self){t.addEventListener("message",function s(n){if(!n||!n.data)return;const{id:r,type:o,path:i}=Object.assign({path:[]},n.data),a=(n.data.argumentList||[]).map(E);let l;try{const d=i.slice(0,-1).reduce((p,L)=>p[L],e),w=i.reduce((p,L)=>p[L],e);switch(o){case"GET":l=w;break;case"SET":d[i.slice(-1)[0]]=E(n.data.value),l=!0;break;case"APPLY":l=w.apply(d,a);break;case"CONSTRUCT":{const p=new w(...a);l=ye(p)}break;case"ENDPOINT":{const{port1:p,port2:L}=new MessageChannel;be(e,L),l=rt(p,[p])}break;case"RELEASE":l=void 0;break;default:return}}catch(d){l={value:d,[K]:0}}Promise.resolve(l).catch(d=>({value:d,[K]:0})).then(d=>{const[w,p]=Y(d);t.postMessage(Object.assign(Object.assign({},w),{id:r}),p),o==="RELEASE"&&(t.removeEventListener("message",s),we(t))})}),t.start&&t.start()}function nt(e){return e.constructor.name==="MessagePort"}function we(e){nt(e)&&e.close()}function Ee(e,t){return V(e,[],t)}function F(e){if(e)throw new Error("Proxy has been released and is not useable")}function V(e,t=[],s=function(){}){let n=!1;const r=new Proxy(s,{get(o,i){if(F(n),i===qe)return()=>v(e,{type:"RELEASE",path:t.map(a=>a.toString())}).then(()=>{we(e),n=!0});if(i==="then"){if(t.length===0)return{then:()=>r};const a=v(e,{type:"GET",path:t.map(l=>l.toString())}).then(E);return a.then.bind(a)}return V(e,[...t,i])},set(o,i,a){F(n);const[l,d]=Y(a);return v(e,{type:"SET",path:[...t,i].map(w=>w.toString()),value:l},d).then(E)},apply(o,i,a){F(n);const l=t[t.length-1];if(l===Ze)return v(e,{type:"ENDPOINT"}).then(E);if(l==="bind")return V(e,t.slice(0,-1));const[d,w]=te(a);return v(e,{type:"APPLY",path:t.map(p=>p.toString()),argumentList:d},w).then(E)},construct(o,i){F(n);const[a,l]=te(i);return v(e,{type:"CONSTRUCT",path:t.map(d=>d.toString()),argumentList:a},l).then(E)}});return r}function st(e){return Array.prototype.concat.apply([],e)}function te(e){const t=e.map(Y);return[t.map(s=>s[0]),st(t.map(s=>s[1]))]}const ve=new WeakMap;function rt(e,t){return ve.set(e,t),e}function ye(e){return Object.assign(e,{[ge]:!0})}function ot(e,t=self,s="*"){return{postMessage:(n,r)=>e.postMessage(n,s,r),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function Y(e){for(const[t,s]of he)if(s.canHandle(e)){const[n,r]=s.serialize(e);return[{type:"HANDLER",name:t,value:n},r]}return[{type:"RAW",value:e},ve.get(e)||[]]}function E(e){switch(e.type){case"HANDLER":return he.get(e.name).deserialize(e.value);case"RAW":return e.value}}function v(e,t,s){return new Promise(n=>{const r=it();e.addEventListener("message",function o(i){!i.data||!i.data.id||i.data.id!==r||(e.removeEventListener("message",o),n(i.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:r},t),s)})}function it(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const at="0.4.2",lt=at,S=x("[Settings window communication]");let A=null;const Le=new URL("https://woyken.github.io/krunker-qoli/#userScriptSettings"),N=[];window.addEventListener("message",e=>{e.origin===Le.origin&&e.stopImmediatePropagation(),N.filter(t=>t.type==="message").forEach(({listener:t})=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function ct(e){S.log("settingsUpdatedCallback",e),Be(e.enabledFastRespawn),We(e.enabledAdPopupRemoval),Oe(e.enabledAutoReload)}let U;function j(){U=void 0,A&&(A.close(),A=null)}function ut(e,t){return new Promise((s,n)=>{setTimeout(()=>{n(new Error("Promise timed out"))},t),e.then(s,n)})}async function dt(){const e=k.open(Le.href,"settingsWindow","width=400,height=400");if(!e)throw alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new Error("Failed to open settings window");j(),A=e;const t=ot(A,{addEventListener(r,o){N.push({type:r,listener:o})},removeEventListener(r,o){const i=N.findIndex(({type:a,listener:l})=>a===r&&l===o);i>=0&&N.splice(i,1)}},"*"),s=Ee(t);return await new Promise(r=>{S.log("waiting for settings window");const o=setInterval(()=>{S.log("checking for settings window"),ut(s.ping,200).then(()=>{clearInterval(o),r()})},200)}).then(()=>{s.onUnloadPromise.then(()=>{S.log("settings window unloaded"),j()})}),S.log("settings window available"),s.registerCallback(lt,ye(ct)),s}async function ft(){return U||(U=dt()),U}window.addEventListener("beforeunload",()=>{j()});Ke();Je();Ve();ft();
