
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.5.9
// @description  Krunker quality of life improvements
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

function _e(){throw window.alert('[Krunker Qoli] Script was injected too late, please use "instant inject" option'),"Script injected too late, don't want to risk alarming anticheat"}document.getElementsByTagName("script").length>0&&_e();function ze(e,t,n){const o=t,s=Object.getOwnPropertyNames(o);for(let i=0;i<s.length;i+=1){const r=Object.getOwnPropertyDescriptor(o,s[i]);if(r){const c={...r};r.get&&(c.get=r.get.bind(n)),r.set&&(c.set=r.set.bind(n)),typeof r.value=="function"&&(c.value=r.value.bind(n)),(c.get||c.set||c.value)&&Object.defineProperty(e,s[i],c)}}}function _(e,t,n){let o=Object.getPrototypeOf(t);for(;o!=null;)ze(e,o,n),o=Object.getPrototypeOf(o)}const Y=new Map;function ye(e){if(Y.has(e))return Y.get(e);const t=Object.getPrototypeOf(e);let n;return t?n=Object.create(ye(t)):n=Object.create(null),Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)),Y.set(e,n),n}function x(e,t){const n=Object.getOwnPropertyNames(t).filter(o=>!new Array("prototype").includes(o));for(let o=0;o<n.length;o+=1){const s=Object.getOwnPropertyDescriptor(t,n[o]);if(s){const i={...s};s.get&&(i.get=s.get.bind(t)),s.set&&(i.set=s.set.bind(t)),typeof s.value=="function"&&(i.value=s.value.bind(t)),(i.get||i.set||i.value)&&Object.defineProperty(e,n[o],i)}}}const Qe=(e,t)=>class extends e{constructor(...n){super(...n),Object.setPrototypeOf(this,t)}};function L(e){const t=Qe(e,ye(e.prototype));return x(t,e),t}const a=L(Array),ve=L(MessageChannel),Xe=Symbol.apply.bind(Symbol);function S(...e){return Xe(null,e)}x(S,Symbol);const k=L(Object),Ye=L(Map),z=L(Promise),M=L(Error),J=Object.create(null);x(J,Math);let ne=!1;Proxy.prototype||(ne=!0);ne&&(Proxy.prototype=Object.create(null));const Ee=L(Proxy);ne&&delete Proxy.prototype;new a;const qe=(e,t)=>e===t;S("solid-proxy");S("solid-track");S("solid-dev-component");const K={equals:qe};let Le=Pe;const U={},O=1,V=2,Je={owned:null,cleanups:null,context:null,owner:null};var y=null;let F=null,w=null,T=null,m=null,C=null,oe=0;function p(e,t){t=t?k.assign({},K,t):K;const n={value:e,observers:null,observerSlots:null,pending:U,comparator:t.equals||void 0},o=s=>(typeof s=="function"&&(s=s(n.pending!==U?n.pending:n.value)),se(n,s));return new a(Se.bind(n),o)}function Ze(e,t,n){const o=re(e,t,!0,O);N(o)}function g(e,t,n){Le=rt;const o=re(e,t,!1,O);o.user=!0,C?C.push(o):N(o)}function fe(e,t,n){n=n?k.assign({},K,n):K;const o=re(e,t,!0,0);return o.pending=U,o.observers=null,o.observerSlots=null,o.comparator=n.equals||void 0,N(o),Se.bind(o)}function et(e){if(T)return e();let t;const n=T=new a;try{t=e()}finally{T=null}return ke(()=>{for(let o=0;o<n.length;o+=1){const s=n[o];if(s.pending!==U){const i=s.pending;s.pending=U,se(s,i)}}},!1),t}function Ce(e){let t,n=w;return w=null,t=e(),w=n,t}function E(e){return y===null||(y.cleanups===null?y.cleanups=new a(e):y.cleanups.push(e)),e}function tt(e){const t=S("context");return{id:t,Provider:it(t),defaultValue:e}}function nt(e){const t=fe(e);return fe(()=>Z(t()))}function Se(){const e=F;if(this.sources&&(this.state||e)){const t=m;m=null,this.state===O||e?N(this):$(this),m=t}if(w){const t=this.observers?this.observers.length:0;w.sources?(w.sources.push(this),w.sourceSlots.push(t)):(w.sources=new a(this),w.sourceSlots=new a(t)),this.observers?(this.observers.push(w),this.observerSlots.push(w.sources.length-1)):(this.observers=new a(w),this.observerSlots=new a(w.sources.length-1))}return this.value}function se(e,t,n){if(T)return e.pending===U&&T.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let o=!1;return e.value=t,e.observers&&e.observers.length&&ke(()=>{for(let s=0;s<e.observers.length;s+=1){const i=e.observers[s];o&&F.disposed.has(i),(o&&!i.tState||!o&&!i.state)&&(i.pure?m.push(i):C.push(i),i.observers&&Ie(i)),o||(i.state=O)}if(m.length>1e6)throw m=new a,new M},!1),t}function N(e){if(!e.fn)return;Oe(e);const t=y,n=w,o=oe;w=y=e,ot(e,e.value,o),w=n,y=t}function ot(e,t,n){let o;try{o=e.fn(t)}catch(s){Ae(s)}(!e.updatedAt||e.updatedAt<=n)&&(e.observers&&e.observers.length?se(e,o):e.value=o,e.updatedAt=n)}function re(e,t,n,o=O,s){const i={fn:e,state:o,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:y,context:null,pure:n};return y===null||y!==Je&&(y.owned?y.owned.push(i):y.owned=new a(i)),i}function W(e){const t=F;if(e.state===0||t)return;if(e.state===V||t)return $(e);if(e.suspense&&Ce(e.suspense.inFallback))return e.suspense.effects.push(e);const n=new a(e);for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<oe);)(e.state||t)&&n.push(e);for(let o=n.length-1;o>=0;o--)if(e=n[o],e.state===O||t)N(e);else if(e.state===V||t){const s=m;m=null,$(e,n[0]),m=s}}function ke(e,t){if(m)return e();let n=!1;t||(m=new a),C?n=!0:C=new a,oe++;try{const o=e();return st(n),o}catch(o){Ae(o)}finally{m=null,n||(C=null)}}function st(e){m&&(Pe(m),m=null),!e&&(C.length?et(()=>{Le(C),C=null}):C=null)}function Pe(e){for(let t=0;t<e.length;t++)W(e[t])}function rt(e){let t,n=0;for(t=0;t<e.length;t++){const s=e[t];s.user?e[n++]=s:W(s)}const o=e.length;for(t=0;t<n;t++)W(e[t]);for(t=o;t<e.length;t++)W(e[t])}function $(e,t){const n=F;e.state=0;for(let o=0;o<e.sources.length;o+=1){const s=e.sources[o];s.sources&&(s.state===O||n?s!==t&&W(s):(s.state===V||n)&&$(s,t))}}function Ie(e){const t=F;for(let n=0;n<e.observers.length;n+=1){const o=e.observers[n];(!o.state||t)&&(o.state=V,o.pure?m.push(o):C.push(o),o.observers&&Ie(o))}}function Oe(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),o=e.sourceSlots.pop(),s=n.observers;if(s&&s.length){const i=s.pop(),r=n.observerSlots.pop();o<s.length&&(i.sourceSlots[r]=o,s[o]=i,n.observerSlots[o]=r)}}if(e.owned){for(t=0;t<e.owned.length;t++)Oe(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function Ae(e){throw e}function Z(e){if(typeof e=="function"&&!e.length)return Z(e());if(a.isArray(e)){const t=new a;for(let n=0;n<e.length;n++){const o=Z(e[n]);a.isArray(o)?t.push.apply(t,o):t.push(o)}return t}return e}function it(e){return function(n){let o;return Ze(()=>o=Ce(()=>(y.context={[e]:n.value},nt(()=>n.children)))),o}}S("fallback");tt();const d={};_(d,document,document);const ie={};_(ie,console,console);x(ie,console);class ae{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new ae(...this.argsScope,...t)}log(...t){ie.log(...this.argsScope,...t)}}function A(...e){return new ae("[Krunker Qoli]",...e)}const at=A("[documentState]"),[B,pe]=p(!1);d.readyState!=="complete"?d.addEventListener("readystatechange",function e(){d.readyState==="complete"&&(d.removeEventListener("readystatechange",e),at.log("document readyState complete event received, setting state true"),pe(!0))}):pe(!0);function ct(){const[e,t]=p(d.readyState),n=()=>d.readyState==="loading",o=()=>d.readyState==="interactive",s=()=>d.readyState==="complete",[i,r]=p(n()||o()||s()),[c,l]=p(o()||s()),[u,h]=p(s());return d.addEventListener("readystatechange",function b(){t(d.readyState),r(n()||o()||s()),l(o()||s()),h(s()),s()&&d.removeEventListener("readystatechange",b)}),{documentReadyState:e,isDocumentAtLeastLoading:i,isDocumentAtLeastInteractive:c,isDocumentAtLeastComplete:u}}const[en,lt]=p(!1),[ut,dt]=p(!1),[Re,ft]=p(!1),[pt,gt]=p(!1),wt=L(MutationObserver);function mt(e){return new wt(t=>{t.forEach(n=>{n.type==="attributes"&&n.attributeName==="style"&&e(n.target.style)})})}function Q(e){return mt(t=>{const n=t.display==="block";e(n)})}const X={attributes:!0,attributeFilter:new a("style")},q=A("[adPopupDismisser]");function ht(){q.log("initAdPopupDismisser");const[e,t]=p(!1),n=Q(t);g(()=>{if(!B())return;q.log("document readyState complete, adding observer");const o=d.getElementById("popupHolder");o&&(t(o.style.display==="block"),n.observe(o,X),E(n.disconnect.bind(n)))}),g(()=>{!ut()||(q.log("isAdPopupActive effect",e()),e()&&d.getElementById("popupBack")?.click())})}const ge=L(KeyboardEvent);function Me(){const[e,t]=p(!1),n=Q(t);return g(()=>{if(!B())return;const o=d.getElementById("inGameUI");o&&(t(o.style.display==="block"),n.observe(o,X),E(n.disconnect.bind(n)))}),e}const H=A("[autoReload]");function bt(){H.log("initAutoReload");const e=Me(),[t,n]=p(!1),o=Q(n);g(()=>{if(!B())return;H.log("document readyState complete, adding observer");const r=d.getElementById("reloadMsg");r&&(n(r.style.display==="block"),o.observe(r,X),E(o.disconnect.bind(o)))});const[s,i]=p(!1);g(()=>{if(!Re()||!t())return;H.log("pressing down reload button");const r=a.from(d.getElementsByTagName("canvas")).pop(),c={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new ge("keydown",c)),i(!0)}),g(()=>{if(!s()||!e()||t())return;H.log("releasing reload button");const r=a.from(d.getElementsByTagName("canvas")).pop(),c={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new ge("keyup",c))})}const we=L(MouseEvent),f={location:{}};_(f,window,window);_(f.location,window.location,window.location);x(f.location,window.location);x(f,window);function yt(){const[e,t]=p(d.hasFocus()),n=()=>t(!0),o=()=>t(!1);return f.addEventListener("focus",n),f.addEventListener("blur",o),E(()=>{f.removeEventListener("focus",n),f.removeEventListener("blur",o)}),e}function vt(){const[e,t]=p(!1);function n(){t(!!d.pointerLockElement)}return g(()=>{!B()||(d.addEventListener("pointerlockchange",n),E(()=>{d.removeEventListener("pointerlockchange",n)}))}),e}function Et(){const[e,t]=p(!1),n=Q(t);return g(()=>{if(!B())return;const o=d.getElementById("killCardHolder");o&&(t(o.style.display==="block"),n.observe(o,X),E(n.disconnect.bind(n)))}),e}let Ue=()=>({events:{},emit(e,...t){let n=this.events[e]||new a;for(let o=0,s=n.length;o<s;o++)n[o](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=new a(t)),()=>{this.events[e]=this.events[e]?.filter(n=>t!==n)}}});function xe(e){return{on:e.on.bind(e)}}const Lt=Function.prototype.apply.apply.bind(Function.prototype.apply);function Ct(e){return typeof e!="object"||e==null?!1:"stack"in e}function ce(e,t,n){const o=A("[createFunctionProxy]",e,t,n);return o.log("creating function proxy"),new Ee(e,{apply(s,i,r){const c=o.createScopedLogger("[apply]",s,i,r);try{t?.(...r)}catch(u){c.log("beforeCallback error",u)}let l;try{l=Lt(s,new a(i,r))}catch(u){throw c.log("EXCEPTION",u),Ct(u)&&(u.stack.includes("Object.apply")?u.stack=u.stack.replace(/\n.*Object\.apply.*/,""):u.stack.includes("apply@")&&(u.stack=u.stack.replace(/.*apply@.*\n/,""))),c.log("EXCEPTION before rethrow",u),u}try{n?.(l,...r)}catch(u){c.log("afterCallback error",u)}return l}})}const De=Ue(),St=document.exitPointerLock;document.exitPointerLock=ce(St,void 0,()=>De.emit("calledExitPointerLock"));var kt=xe(De);const Te=A("[fastRespawn]");function Pt(){Te.log("trying to activate game");const e=a.from(d.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new we("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new we("mouseup",{bubbles:!0,cancelable:!0}))}function It(){Te.log("initFastRespawn");const e=Et(),t=Me(),n=vt(),o=yt(),[s,i]=p(!1),r=kt.on("calledExitPointerLock",()=>{n()&&i(!0)});E(()=>{r()}),g(()=>{n()&&i(!1)}),g(()=>{!Re()||!o()||!s()||n()||t()||!e()||(i(!1),Pt())})}const le=L(URL),Ot=L(WeakMap),At=L(Number),We=S("Comlink.proxy"),Rt=S("Comlink.endpoint"),Mt=S("Comlink.releaseProxy"),ee=S("Comlink.thrown"),Fe=e=>typeof e=="object"&&e!==null||typeof e=="function",Ut={canHandle:e=>Fe(e)&&e[We],serialize(e){const{port1:t,port2:n}=new ve;return Be(e,t),new a(n,new a(n))},deserialize(e){return e.start(),He(e)}},xt={canHandle:e=>Fe(e)&&ee in e,serialize({value:e}){let t;return e instanceof M?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},new a(t,new a)},deserialize(e){throw e.isError?k.assign(new M(e.value.message),e.value):e.value}},Ne=new Ye(new a(new a("proxy",Ut),new a("throw",xt)));function Be(e,t=self){t.addEventListener("message",function n(o){if(!o||!o.data)return;const{id:s,type:i,path:r}=k.assign({path:new a},o.data),c=(o.data.argumentList||new a).map(I);let l;try{const u=r.slice(0,-1).reduce((b,D)=>b[D],e),h=r.reduce((b,D)=>b[D],e);switch(i){case"GET":l=h;break;case"SET":u[r.slice(-1)[0]]=I(o.data.value),l=!0;break;case"APPLY":l=h.apply(u,c);break;case"CONSTRUCT":{const b=new h(...c);l=Ke(b)}break;case"ENDPOINT":{const{port1:b,port2:D}=new ve;Be(e,D),l=Wt(b,new a(b))}break;case"RELEASE":l=void 0;break;default:return}}catch(u){l={value:u,[ee]:0}}z.resolve(l).catch(u=>({value:u,[ee]:0})).then(u=>{const[h,b]=ue(u);t.postMessage(k.assign(k.assign({},h),{id:s}),b),i==="RELEASE"&&(t.removeEventListener("message",n),je(t))})}),t.start&&t.start()}function Dt(e){return e.constructor.name==="MessagePort"}function je(e){Dt(e)&&e.close()}function He(e,t){return te(e,new a,t)}function G(e){if(e)throw new M("Proxy has been released and is not useable")}function te(e,t=new a,n=function(){}){let o=!1;const s=new Ee(n,{get(i,r){if(G(o),r===Mt)return()=>R(e,{type:"RELEASE",path:t.map(c=>c.toString())}).then(()=>{je(e),o=!0});if(r==="then"){if(t.length===0)return{then:()=>s};const c=R(e,{type:"GET",path:t.map(l=>l.toString())}).then(I);return c.then.bind(c)}return te(e,new a(...t,r))},set(i,r,c){G(o);const[l,u]=ue(c);return R(e,{type:"SET",path:new a(...t,r).map(h=>h.toString()),value:l},u).then(I)},apply(i,r,c){G(o);const l=t[t.length-1];if(l===Rt)return R(e,{type:"ENDPOINT"}).then(I);if(l==="bind")return te(e,t.slice(0,-1));const[u,h]=me(c);return R(e,{type:"APPLY",path:t.map(b=>b.toString()),argumentList:u},h).then(I)},construct(i,r){G(o);const[c,l]=me(r);return R(e,{type:"CONSTRUCT",path:t.map(u=>u.toString()),argumentList:c},l).then(I)}});return s}function Tt(e){return a.prototype.concat.apply(new a,e)}function me(e){const t=e.map(ue);return new a(t.map(n=>n[0]),Tt(t.map(n=>n[1])))}const Ge=new Ot;function Wt(e,t){return Ge.set(e,t),e}function Ke(e){return k.assign(e,{[We]:!0})}function Ft(e,t=self,n="*"){return{postMessage:(o,s)=>e.postMessage(o,n,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function ue(e){for(const[t,n]of Ne)if(n.canHandle(e)){const[o,s]=n.serialize(e);return new a({type:"HANDLER",name:t,value:o},s)}return new a({type:"RAW",value:e},Ge.get(e)||new a)}function I(e){switch(e.type){case"HANDLER":return Ne.get(e.name).deserialize(e.value);case"RAW":return e.value}}function R(e,t,n){return new z(o=>{const s=Nt();e.addEventListener("message",function i(r){!r.data||!r.data.id||r.data.id!==s||(e.removeEventListener("message",i),o(r.data))}),e.start&&e.start(),e.postMessage(k.assign({id:s},t),n)})}function Nt(){return new a(4).fill(0).map(()=>J.floor(J.random()*At.MAX_SAFE_INTEGER).toString(16)).join("-")}const Bt="0.5.9",jt=Bt;function Ht(...e){const t=Ft(...e),n={},o=t.addEventListener.bind(t);t.addEventListener=(...r)=>{const c=n[r[0]];return c?c.push(r[1]):n[r[0]]=new a(r[1]),o(...r)};const s=t.removeEventListener.bind(t);t.removeEventListener=(...r)=>{const c=n[r[0]];return c&&(n[r[0]]=c.filter(l=>l!==r[1])),s(...r)};function i(){k.keys(n).forEach(r=>{n[r].forEach(c=>{s(r,c)})})}return{unsubscribeAll:i,...t}}const Gt=A("[useRemoveClosedWindows]");function Kt(e,t){const n=setInterval(()=>{const o=e();o&&o.closed&&(Gt.log("is closed",e()),t())},1e3);E(()=>clearInterval(n))}const j=Ue(),Vt=window.history.pushState;window.history.pushState=ce(Vt,void 0,()=>j.emit("locationChanged"));const $t=window.history.replaceState;window.history.replaceState=ce($t,void 0,()=>j.emit("locationChanged"));window.addEventListener("hashchange",()=>j.emit("locationChanged"));window.addEventListener("popstate",()=>j.emit("locationChanged"));var _t=xe(j);function Ve(){const[e,t]=p(f.location.href);return _t.on("locationChanged",()=>{t(f.location.href)}),e}const v=A("[Settings window communication]"),$e=le,de=new $e("https://woyken.github.io/krunker-qoli"),P={};f.addEventListener("message",e=>{e.origin===de.origin&&e.stopImmediatePropagation(),P.message?.forEach(t=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function zt(e){v.log("settingsUpdatedCallback",e),ft(e.enabledFastRespawn),dt(e.enabledAdPopupRemoval),lt(e.enabledAutoReload),gt(e.enabledWindowManager)}function he(e,t){return new z((n,o)=>{setTimeout(()=>{o(new M("Promise timed out"))},t),e.then(n,o)})}let be=!1;function Qt(){const[e,t]=p();if(f.opener)t(f.opener);else{const{isDocumentAtLeastInteractive:n}=ct();g(()=>{if(be||!n())return;v.log("opening new settings window");const o=f.open(new $e("#userScriptSettings",de).href,"settingsWindow","width=400,height=450");if(be=!0,!o)throw f.alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new M("Failed to open settings window");t(o),E(()=>{v.log("onCleanup, closing settings window",o),o.close()});function s(){v.log("handleBeforeUnload, closing settings window",o),o?.close()}f.addEventListener("beforeunload",s),E(()=>f.removeEventListener("beforeunload",s)),Kt(e,t)})}return e}async function Xt(e){const[t,n]=p("connecting");E(()=>n("disposed"));const o=Ht(e,{addEventListener(l,u){P[l]?P[l].push(u):P[l]=new a(u)},removeEventListener(l,u){P[l]&&(P[l]=P[l].filter(h=>h!==u))}},"*"),s=He(o);E(()=>o.unsubscribeAll());function i(){s.scriptUnloading().catch(l=>v.log("on beforeUnload error",l))}f.addEventListener("beforeunload",i),E(()=>f.removeEventListener("beforeunload",i));const r=Ve();g(()=>{s.scriptLocationChanged(r())});const c=new z(l=>{v.log("waiting for settings window");const u=setInterval(()=>{v.log("checking for settings window"),he(s.ping,200).then(()=>{clearInterval(u),l()}).catch(h=>{v.log("[onSettingsWindowAvailablePromise]","error",h)})},200)});return he(c,6e4).then(()=>{s.onUnloadPromise.then(()=>{v.log("settings window unloaded"),n("disposed")}),v.log("settings window available"),n("available")}).catch(l=>{v.log("settings window connection error",l),n("error")}),g(()=>{v.log("settings connection state changed",t()),t()==="available"&&(v.log("registering for remote settings callbacks"),s.registerSettingsCallback(jt,Ke(zt)))}),{state:t,remoteExposedSettings:s}}function Yt(){const e=Qt(),[t,n]=p();return g(()=>{const o=e();if(!o)return;const s=Xt(o);n(s)}),t}function qt(){g(()=>{if(!pt()||f.opener)return;const e=f.location.href,t=new le(`#windowManager?redirectKrunkerUrl=${e}`,de);f.open(t,"_self")})}function Jt(){const[e,t]=p(!1),n=Ve();return g(()=>new le(n()).pathname==="/"?t(!0):t(!1)),e}function Zt(){const e=Jt();g(()=>{!e()||(ht(),It(),bt(),qt(),Yt())})}Zt();
