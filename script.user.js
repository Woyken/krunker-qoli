
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.5.9
// @description  Krunker quality of life improvements
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

function ze(){throw window.alert('[Krunker Qoli] Script was injected too late, please use "instant inject" option'),"Script injected too late, don't want to risk alarming anticheat"}document.getElementsByTagName("script").length>0&&ze();function Qe(e,t,n){const o=t,s=Object.getOwnPropertyNames(o);for(let r=0;r<s.length;r+=1){const i=Object.getOwnPropertyDescriptor(o,s[r]);if(i){const a={...i};i.get&&(a.get=i.get.bind(n)),i.set&&(a.set=i.set.bind(n)),typeof i.value=="function"&&(a.value=i.value.bind(n)),(a.get||a.set||a.value)&&Object.defineProperty(e,s[r],a)}}}function _(e,t,n){let o=Object.getPrototypeOf(t);for(;o!=null;)Qe(e,o,n),o=Object.getPrototypeOf(o)}const Y=new Map;function ye(e){if(Y.has(e))return Y.get(e);const t=Object.getPrototypeOf(e);let n;return t?n=Object.create(ye(t)):n=Object.create(null),Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)),Y.set(e,n),n}function x(e,t){const n=Object.getOwnPropertyNames(t).filter(o=>!new Array("prototype").includes(o));for(let o=0;o<n.length;o+=1){const s=Object.getOwnPropertyDescriptor(t,n[o]);if(s){const r={...s};s.get&&(r.get=s.get.bind(t)),s.set&&(r.set=s.set.bind(t)),typeof s.value=="function"&&(r.value=s.value.bind(t)),(r.get||r.set||r.value)&&Object.defineProperty(e,n[o],r)}}}const Xe=(e,t)=>class extends e{constructor(...n){super(...n),Object.setPrototypeOf(this,t)}};function L(e){const t=Xe(e,ye(e.prototype));return x(t,e),t}const c=L(Array),ve=L(MessageChannel),Ye=Symbol.apply.bind(Symbol);function S(...e){return Ye(null,e)}x(S,Symbol);const k=L(Object),qe=L(Map),z=L(Promise),M=L(Error),J=Object.create(null);x(J,Math);let ne=!1;Proxy.prototype||(ne=!0);ne&&(Proxy.prototype=Object.create(null));const Ee=L(Proxy);ne&&delete Proxy.prototype;new c;const Je=(e,t)=>e===t;S("solid-proxy");S("solid-track");S("solid-dev-component");const K={equals:Je};let Le=Pe;const U={},O=1,V=2,Ze={owned:null,cleanups:null,context:null,owner:null};var y=null;let F=null,w=null,T=null,m=null,C=null,oe=0;function p(e,t){t=t?k.assign({},K,t):K;const n={value:e,observers:null,observerSlots:null,pending:U,comparator:t.equals||void 0},o=s=>(typeof s=="function"&&(s=s(n.pending!==U?n.pending:n.value)),se(n,s));return new c(Se.bind(n),o)}function et(e,t,n){const o=re(e,t,!0,O);N(o)}function g(e,t,n){Le=it;const o=re(e,t,!1,O);o.user=!0,C?C.push(o):N(o)}function fe(e,t,n){n=n?k.assign({},K,n):K;const o=re(e,t,!0,0);return o.pending=U,o.observers=null,o.observerSlots=null,o.comparator=n.equals||void 0,N(o),Se.bind(o)}function tt(e){if(T)return e();let t;const n=T=new c;try{t=e()}finally{T=null}return ke(()=>{for(let o=0;o<n.length;o+=1){const s=n[o];if(s.pending!==U){const r=s.pending;s.pending=U,se(s,r)}}},!1),t}function Ce(e){let t,n=w;return w=null,t=e(),w=n,t}function E(e){return y===null||(y.cleanups===null?y.cleanups=new c(e):y.cleanups.push(e)),e}function nt(e){const t=S("context");return{id:t,Provider:at(t),defaultValue:e}}function ot(e){const t=fe(e);return fe(()=>Z(t()))}function Se(){const e=F;if(this.sources&&(this.state||e)){const t=m;m=null,this.state===O||e?N(this):$(this),m=t}if(w){const t=this.observers?this.observers.length:0;w.sources?(w.sources.push(this),w.sourceSlots.push(t)):(w.sources=new c(this),w.sourceSlots=new c(t)),this.observers?(this.observers.push(w),this.observerSlots.push(w.sources.length-1)):(this.observers=new c(w),this.observerSlots=new c(w.sources.length-1))}return this.value}function se(e,t,n){if(T)return e.pending===U&&T.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let o=!1;return e.value=t,e.observers&&e.observers.length&&ke(()=>{for(let s=0;s<e.observers.length;s+=1){const r=e.observers[s];o&&F.disposed.has(r),(o&&!r.tState||!o&&!r.state)&&(r.pure?m.push(r):C.push(r),r.observers&&Ie(r)),o||(r.state=O)}if(m.length>1e6)throw m=new c,new M},!1),t}function N(e){if(!e.fn)return;Oe(e);const t=y,n=w,o=oe;w=y=e,st(e,e.value,o),w=n,y=t}function st(e,t,n){let o;try{o=e.fn(t)}catch(s){Ae(s)}(!e.updatedAt||e.updatedAt<=n)&&(e.observers&&e.observers.length?se(e,o):e.value=o,e.updatedAt=n)}function re(e,t,n,o=O,s){const r={fn:e,state:o,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:y,context:null,pure:n};return y===null||y!==Ze&&(y.owned?y.owned.push(r):y.owned=new c(r)),r}function W(e){const t=F;if(e.state===0||t)return;if(e.state===V||t)return $(e);if(e.suspense&&Ce(e.suspense.inFallback))return e.suspense.effects.push(e);const n=new c(e);for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<oe);)(e.state||t)&&n.push(e);for(let o=n.length-1;o>=0;o--)if(e=n[o],e.state===O||t)N(e);else if(e.state===V||t){const s=m;m=null,$(e,n[0]),m=s}}function ke(e,t){if(m)return e();let n=!1;t||(m=new c),C?n=!0:C=new c,oe++;try{const o=e();return rt(n),o}catch(o){m||(C=null),Ae(o)}}function rt(e){m&&(Pe(m),m=null),!e&&(C.length?tt(()=>{Le(C),C=null}):C=null)}function Pe(e){for(let t=0;t<e.length;t++)W(e[t])}function it(e){let t,n=0;for(t=0;t<e.length;t++){const s=e[t];s.user?e[n++]=s:W(s)}const o=e.length;for(t=0;t<n;t++)W(e[t]);for(t=o;t<e.length;t++)W(e[t])}function $(e,t){const n=F;e.state=0;for(let o=0;o<e.sources.length;o+=1){const s=e.sources[o];s.sources&&(s.state===O||n?s!==t&&W(s):(s.state===V||n)&&$(s,t))}}function Ie(e){const t=F;for(let n=0;n<e.observers.length;n+=1){const o=e.observers[n];(!o.state||t)&&(o.state=V,o.pure?m.push(o):C.push(o),o.observers&&Ie(o))}}function Oe(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),o=e.sourceSlots.pop(),s=n.observers;if(s&&s.length){const r=s.pop(),i=n.observerSlots.pop();o<s.length&&(r.sourceSlots[i]=o,s[o]=r,n.observerSlots[o]=i)}}if(e.owned){for(t=0;t<e.owned.length;t++)Oe(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function Ae(e){throw e}function Z(e){if(typeof e=="function"&&!e.length)return Z(e());if(c.isArray(e)){const t=new c;for(let n=0;n<e.length;n++){const o=Z(e[n]);c.isArray(o)?t.push.apply(t,o):t.push(o)}return t}return e}function at(e){return function(n){let o;return et(()=>o=Ce(()=>(y.context={[e]:n.value},ot(()=>n.children)))),o}}S("fallback");nt();const d={};_(d,document,document);const ie={};_(ie,console,console);x(ie,console);class ae{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new ae(...this.argsScope,...t)}log(...t){ie.log(...this.argsScope,...t)}}function A(...e){return new ae("[Krunker Qoli]",...e)}const ct=A("[documentState]"),[B,pe]=p(!1);d.readyState!=="complete"?d.addEventListener("readystatechange",function e(){d.readyState==="complete"&&(d.removeEventListener("readystatechange",e),ct.log("document readyState complete event received, setting state true"),pe(!0))}):pe(!0);function lt(){const[e,t]=p(d.readyState),n=()=>d.readyState==="loading",o=()=>d.readyState==="interactive",s=()=>d.readyState==="complete",[r,i]=p(n()||o()||s()),[a,l]=p(o()||s()),[u,h]=p(s());return d.addEventListener("readystatechange",function b(){t(d.readyState),i(n()||o()||s()),l(o()||s()),h(s()),s()&&d.removeEventListener("readystatechange",b)}),{documentReadyState:e,isDocumentAtLeastLoading:r,isDocumentAtLeastInteractive:a,isDocumentAtLeastComplete:u}}const[en,ut]=p(!1),[dt,ft]=p(!1),[Re,pt]=p(!1),[gt,wt]=p(!1),mt=L(MutationObserver);function ht(e){return new mt(t=>{t.forEach(n=>{n.type==="attributes"&&n.attributeName==="style"&&e(n.target.style)})})}function Q(e){return ht(t=>{const n=t.display==="block";e(n)})}const X={attributes:!0,attributeFilter:new c("style")},q=A("[adPopupDismisser]");function bt(){q.log("initAdPopupDismisser");const[e,t]=p(!1),n=Q(t);g(()=>{if(!B())return;q.log("document readyState complete, adding observer");const o=d.getElementById("popupHolder");o&&(t(o.style.display==="block"),n.observe(o,X),E(n.disconnect.bind(n)))}),g(()=>{!dt()||(q.log("isAdPopupActive effect",e()),e()&&d.getElementById("popupBack")?.click())})}const ge=L(KeyboardEvent);function Me(){const[e,t]=p(!1);function n(){t(!!d.pointerLockElement)}return g(()=>{!B()||(d.addEventListener("pointerlockchange",n),E(()=>{d.removeEventListener("pointerlockchange",n)}))}),e}function Ue(){const[e,t]=p(!1),n=Q(t);return g(()=>{if(!B())return;const o=d.getElementById("inGameUI");o&&(t(o.style.display==="block"),n.observe(o,X),E(n.disconnect.bind(n)))}),e}const H=A("[autoReload]");function yt(){H.log("initAutoReload");const e=Ue(),[t,n]=p(!1),o=Q(n);g(()=>{if(!B())return;H.log("document readyState complete, adding observer");const a=d.getElementById("reloadMsg");a&&(n(a.style.display==="block"),o.observe(a,X),E(o.disconnect.bind(o)))});const[s,r]=p(!1);g(()=>{if(!Re()||!t())return;H.log("pressing down reload button");const a=c.from(d.getElementsByTagName("canvas")).pop(),l={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};a?.dispatchEvent(new ge("keydown",l)),r(!0)});const i=Me();g(()=>{if(!s()||!e()||!i()||t())return;H.log("releasing reload button");const a=c.from(d.getElementsByTagName("canvas")).pop(),l={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};a?.dispatchEvent(new ge("keyup",l))})}const we=L(MouseEvent),f={location:{}};_(f,window,window);_(f.location,window.location,window.location);x(f.location,window.location);x(f,window);function vt(){const[e,t]=p(d.hasFocus()),n=()=>t(!0),o=()=>t(!1);return f.addEventListener("focus",n),f.addEventListener("blur",o),E(()=>{f.removeEventListener("focus",n),f.removeEventListener("blur",o)}),e}function Et(){const[e,t]=p(!1),n=Q(t);return g(()=>{if(!B())return;const o=d.getElementById("killCardHolder");o&&(t(o.style.display==="block"),n.observe(o,X),E(n.disconnect.bind(n)))}),e}let xe=()=>({events:{},emit(e,...t){let n=this.events[e]||new c;for(let o=0,s=n.length;o<s;o++)n[o](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=new c(t)),()=>{this.events[e]=this.events[e]?.filter(n=>t!==n)}}});function De(e){return{on:e.on.bind(e)}}const Lt=Function.prototype.apply.apply.bind(Function.prototype.apply);function Ct(e){return typeof e!="object"||e==null?!1:"stack"in e}function ce(e,t,n){const o=A("[createFunctionProxy]",e,t,n);return o.log("creating function proxy"),new Ee(e,{apply(s,r,i){const a=o.createScopedLogger("[apply]",s,r,i);try{t?.(...i)}catch(u){a.log("beforeCallback error",u)}let l;try{l=Lt(s,new c(r,i))}catch(u){throw a.log("EXCEPTION",u),Ct(u)&&(u.stack.includes("Object.apply")?u.stack=u.stack.replace(/\n.*Object\.apply.*/,""):u.stack.includes("apply@")&&(u.stack=u.stack.replace(/.*apply@.*\n/,""))),a.log("EXCEPTION before rethrow",u),u}try{n?.(l,...i)}catch(u){a.log("afterCallback error",u)}return l}})}const Te=xe(),St=document.exitPointerLock;document.exitPointerLock=ce(St,void 0,()=>Te.emit("calledExitPointerLock"));var kt=De(Te);const We=A("[fastRespawn]");function Pt(){We.log("trying to activate game");const e=c.from(d.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new we("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new we("mouseup",{bubbles:!0,cancelable:!0}))}function It(){We.log("initFastRespawn");const e=Et(),t=Ue(),n=Me(),o=vt(),[s,r]=p(!1),i=kt.on("calledExitPointerLock",()=>{n()&&r(!0)});E(()=>{i()}),g(()=>{n()&&r(!1)}),g(()=>{!Re()||!o()||!s()||n()||t()||!e()||(r(!1),Pt())})}const le=L(URL),Ot=L(WeakMap),At=L(Number),Fe=S("Comlink.proxy"),Rt=S("Comlink.endpoint"),Mt=S("Comlink.releaseProxy"),ee=S("Comlink.thrown"),Ne=e=>typeof e=="object"&&e!==null||typeof e=="function",Ut={canHandle:e=>Ne(e)&&e[Fe],serialize(e){const{port1:t,port2:n}=new ve;return je(e,t),new c(n,new c(n))},deserialize(e){return e.start(),Ge(e)}},xt={canHandle:e=>Ne(e)&&ee in e,serialize({value:e}){let t;return e instanceof M?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},new c(t,new c)},deserialize(e){throw e.isError?k.assign(new M(e.value.message),e.value):e.value}},Be=new qe(new c(new c("proxy",Ut),new c("throw",xt)));function je(e,t=self){t.addEventListener("message",function n(o){if(!o||!o.data)return;const{id:s,type:r,path:i}=k.assign({path:new c},o.data),a=(o.data.argumentList||new c).map(I);let l;try{const u=i.slice(0,-1).reduce((b,D)=>b[D],e),h=i.reduce((b,D)=>b[D],e);switch(r){case"GET":l=h;break;case"SET":u[i.slice(-1)[0]]=I(o.data.value),l=!0;break;case"APPLY":l=h.apply(u,a);break;case"CONSTRUCT":{const b=new h(...a);l=Ve(b)}break;case"ENDPOINT":{const{port1:b,port2:D}=new ve;je(e,D),l=Wt(b,new c(b))}break;case"RELEASE":l=void 0;break;default:return}}catch(u){l={value:u,[ee]:0}}z.resolve(l).catch(u=>({value:u,[ee]:0})).then(u=>{const[h,b]=ue(u);t.postMessage(k.assign(k.assign({},h),{id:s}),b),r==="RELEASE"&&(t.removeEventListener("message",n),He(t))})}),t.start&&t.start()}function Dt(e){return e.constructor.name==="MessagePort"}function He(e){Dt(e)&&e.close()}function Ge(e,t){return te(e,new c,t)}function G(e){if(e)throw new M("Proxy has been released and is not useable")}function te(e,t=new c,n=function(){}){let o=!1;const s=new Ee(n,{get(r,i){if(G(o),i===Mt)return()=>R(e,{type:"RELEASE",path:t.map(a=>a.toString())}).then(()=>{He(e),o=!0});if(i==="then"){if(t.length===0)return{then:()=>s};const a=R(e,{type:"GET",path:t.map(l=>l.toString())}).then(I);return a.then.bind(a)}return te(e,new c(...t,i))},set(r,i,a){G(o);const[l,u]=ue(a);return R(e,{type:"SET",path:new c(...t,i).map(h=>h.toString()),value:l},u).then(I)},apply(r,i,a){G(o);const l=t[t.length-1];if(l===Rt)return R(e,{type:"ENDPOINT"}).then(I);if(l==="bind")return te(e,t.slice(0,-1));const[u,h]=me(a);return R(e,{type:"APPLY",path:t.map(b=>b.toString()),argumentList:u},h).then(I)},construct(r,i){G(o);const[a,l]=me(i);return R(e,{type:"CONSTRUCT",path:t.map(u=>u.toString()),argumentList:a},l).then(I)}});return s}function Tt(e){return c.prototype.concat.apply(new c,e)}function me(e){const t=e.map(ue);return new c(t.map(n=>n[0]),Tt(t.map(n=>n[1])))}const Ke=new Ot;function Wt(e,t){return Ke.set(e,t),e}function Ve(e){return k.assign(e,{[Fe]:!0})}function Ft(e,t=self,n="*"){return{postMessage:(o,s)=>e.postMessage(o,n,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function ue(e){for(const[t,n]of Be)if(n.canHandle(e)){const[o,s]=n.serialize(e);return new c({type:"HANDLER",name:t,value:o},s)}return new c({type:"RAW",value:e},Ke.get(e)||new c)}function I(e){switch(e.type){case"HANDLER":return Be.get(e.name).deserialize(e.value);case"RAW":return e.value}}function R(e,t,n){return new z(o=>{const s=Nt();e.addEventListener("message",function r(i){!i.data||!i.data.id||i.data.id!==s||(e.removeEventListener("message",r),o(i.data))}),e.start&&e.start(),e.postMessage(k.assign({id:s},t),n)})}function Nt(){return new c(4).fill(0).map(()=>J.floor(J.random()*At.MAX_SAFE_INTEGER).toString(16)).join("-")}const Bt="0.5.9",jt=Bt;function Ht(...e){const t=Ft(...e),n={},o=t.addEventListener.bind(t);t.addEventListener=(...i)=>{const a=n[i[0]];return a?a.push(i[1]):n[i[0]]=new c(i[1]),o(...i)};const s=t.removeEventListener.bind(t);t.removeEventListener=(...i)=>{const a=n[i[0]];return a&&(n[i[0]]=a.filter(l=>l!==i[1])),s(...i)};function r(){k.keys(n).forEach(i=>{n[i].forEach(a=>{s(i,a)})})}return{unsubscribeAll:r,...t}}const Gt=A("[useRemoveClosedWindows]");function Kt(e,t){const n=setInterval(()=>{const o=e();o&&o.closed&&(Gt.log("is closed",e()),t())},1e3);E(()=>clearInterval(n))}const j=xe(),Vt=window.history.pushState;window.history.pushState=ce(Vt,void 0,()=>j.emit("locationChanged"));const $t=window.history.replaceState;window.history.replaceState=ce($t,void 0,()=>j.emit("locationChanged"));window.addEventListener("hashchange",()=>j.emit("locationChanged"));window.addEventListener("popstate",()=>j.emit("locationChanged"));var _t=De(j);function $e(){const[e,t]=p(f.location.href);return _t.on("locationChanged",()=>{t(f.location.href)}),e}const v=A("[Settings window communication]"),_e=le,de=new _e("https://woyken.github.io/krunker-qoli"),P={};f.addEventListener("message",e=>{e.origin===de.origin&&e.stopImmediatePropagation(),P.message?.forEach(t=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function zt(e){v.log("settingsUpdatedCallback",e),pt(e.enabledFastRespawn),ft(e.enabledAdPopupRemoval),ut(e.enabledAutoReload),wt(e.enabledWindowManager)}function he(e,t){return new z((n,o)=>{setTimeout(()=>{o(new M("Promise timed out"))},t),e.then(n,o)})}let be=!1;function Qt(){const[e,t]=p();if(f.opener)t(f.opener);else{const{isDocumentAtLeastInteractive:n}=lt();g(()=>{if(be||!n())return;v.log("opening new settings window");const o=f.open(new _e("#userScriptSettings",de).href,"settingsWindow","width=400,height=450");if(be=!0,!o)throw f.alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new M("Failed to open settings window");t(o),E(()=>{v.log("onCleanup, closing settings window",o),o.close()});function s(){v.log("handleBeforeUnload, closing settings window",o),o?.close()}f.addEventListener("beforeunload",s),E(()=>f.removeEventListener("beforeunload",s)),Kt(e,t)})}return e}async function Xt(e){const[t,n]=p("connecting");E(()=>n("disposed"));const o=Ht(e,{addEventListener(l,u){P[l]?P[l].push(u):P[l]=new c(u)},removeEventListener(l,u){P[l]&&(P[l]=P[l].filter(h=>h!==u))}},"*"),s=Ge(o);E(()=>o.unsubscribeAll());function r(){s.scriptUnloading().catch(l=>v.log("on beforeUnload error",l))}f.addEventListener("beforeunload",r),E(()=>f.removeEventListener("beforeunload",r));const i=$e();g(()=>{s.scriptLocationChanged(i())});const a=new z(l=>{v.log("waiting for settings window");const u=setInterval(()=>{v.log("checking for settings window"),he(s.ping,200).then(()=>{clearInterval(u),l()}).catch(h=>{v.log("[onSettingsWindowAvailablePromise]","error",h)})},200)});return he(a,6e4).then(()=>{s.onUnloadPromise.then(()=>{v.log("settings window unloaded"),n("disposed")}),v.log("settings window available"),n("available")}).catch(l=>{v.log("settings window connection error",l),n("error")}),g(()=>{v.log("settings connection state changed",t()),t()==="available"&&(v.log("registering for remote settings callbacks"),s.registerSettingsCallback(jt,Ve(zt)))}),{state:t,remoteExposedSettings:s}}function Yt(){const e=Qt(),[t,n]=p();return g(()=>{const o=e();if(!o)return;const s=Xt(o);n(s)}),t}function qt(){g(()=>{if(!gt()||f.opener)return;const e=f.location.href,t=new le(`#windowManager?redirectKrunkerUrl=${e}`,de);f.open(t,"_self")})}function Jt(){const[e,t]=p(!1),n=$e();return g(()=>new le(n()).pathname==="/"?t(!0):t(!1)),e}function Zt(){const e=Jt();g(()=>{!e()||(bt(),It(),yt(),qt(),Yt())})}Zt();
