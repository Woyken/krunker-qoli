
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.4.0
// @description  
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

const ke=(e,t)=>e===t,Y={equals:ke};let te=se;const T={},S=1,F=2,Pe={owned:null,cleanups:null,context:null,owner:null};var f=null;let x=null,l=null,A=null,c=null,g=null,j=0;function b(e,t){t=t?Object.assign({},Y,t):Y;const n={value:e,observers:null,observerSlots:null,pending:T,comparator:t.equals||void 0},s=r=>(typeof r=="function"&&(r=r(n.pending!==T?n.pending:n.value)),_(n,r));return[Te.bind(n),s]}function E(e,t,n){te=De;const s=Re(e,t,!1,S),r=X&&ae(f,X.id);r&&(s.suspense=r),s.user=!0,g?g.push(s):z(s)}function Ae(e){if(A)return e();let t;const n=A=[];try{t=e()}finally{A=null}return ne(()=>{for(let s=0;s<n.length;s+=1){const r=n[s];if(r.pending!==T){const o=r.pending;r.pending=T,_(r,o)}}},!1),t}function Ie(e){let t,n=l;return l=null,t=e(),l=n,t}function Ce(e){return f===null||(f.cleanups===null?f.cleanups=[e]:f.cleanups.push(e)),e}let X;function Te(){const e=x;if(this.sources&&(this.state||e)){const t=c;c=null,this.state===S||e?z(this):M(this),c=t}if(l){const t=this.observers?this.observers.length:0;l.sources?(l.sources.push(this),l.sourceSlots.push(t)):(l.sources=[this],l.sourceSlots=[t]),this.observers?(this.observers.push(l),this.observerSlots.push(l.sources.length-1)):(this.observers=[l],this.observerSlots=[l.sources.length-1])}return this.value}function _(e,t,n){if(A)return e.pending===T&&A.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let s=!1;return e.value=t,e.observers&&e.observers.length&&ne(()=>{for(let r=0;r<e.observers.length;r+=1){const o=e.observers[r];s&&x.disposed.has(o),(s&&!o.tState||!s&&!o.state)&&(o.pure?c.push(o):g.push(o),o.observers&&re(o)),s||(o.state=S)}if(c.length>1e6)throw c=[],new Error},!1),t}function z(e){if(!e.fn)return;oe(e);const t=f,n=l,s=j;l=f=e,xe(e,e.value,s),l=n,f=t}function xe(e,t,n){let s;try{s=e.fn(t)}catch(r){ie(r)}(!e.updatedAt||e.updatedAt<=n)&&(e.observers&&e.observers.length?_(e,s):e.value=s,e.updatedAt=n)}function Re(e,t,n,s=S,r){const o={fn:e,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:f,context:null,pure:n};return f===null||f!==Pe&&(f.owned?f.owned.push(o):f.owned=[o]),o}function I(e){const t=x;if(e.state===0||t)return;if(e.state===F||t)return M(e);if(e.suspense&&Ie(e.suspense.inFallback))return e.suspense.effects.push(e);const n=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<j);)(e.state||t)&&n.push(e);for(let s=n.length-1;s>=0;s--)if(e=n[s],e.state===S||t)z(e);else if(e.state===F||t){const r=c;c=null,M(e,n[0]),c=r}}function ne(e,t){if(c)return e();let n=!1;t||(c=[]),g?n=!0:g=[],j++;try{const s=e();return Oe(n),s}catch(s){ie(s)}finally{c=null,n||(g=null)}}function Oe(e){c&&(se(c),c=null),!e&&(g.length?Ae(()=>{te(g),g=null}):g=null)}function se(e){for(let t=0;t<e.length;t++)I(e[t])}function De(e){let t,n=0;for(t=0;t<e.length;t++){const r=e[t];r.user?e[n++]=r:I(r)}const s=e.length;for(t=0;t<n;t++)I(e[t]);for(t=s;t<e.length;t++)I(e[t])}function M(e,t){const n=x;e.state=0;for(let s=0;s<e.sources.length;s+=1){const r=e.sources[s];r.sources&&(r.state===S||n?r!==t&&I(r):(r.state===F||n)&&M(r,t))}}function re(e){const t=x;for(let n=0;n<e.observers.length;n+=1){const s=e.observers[n];(!s.state||t)&&(s.state=F,s.pure?c.push(s):g.push(s),s.observers&&re(s))}}function oe(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),s=e.sourceSlots.pop(),r=n.observers;if(r&&r.length){const o=r.pop(),i=n.observerSlots.pop();s<r.length&&(o.sourceSlots[i]=s,r[s]=o,n.observerSlots[s]=i)}}if(e.owned){for(t=0;t<e.owned.length;t++)oe(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function ie(e){throw e}function ae(e,t){return e?e.context&&e.context[t]!==void 0?e.context[t]:ae(e.owner,t):void 0}const Fe=console.log.bind(console);class Q{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new Q(...this.argsScope,...t)}log(...t){Fe(...this.argsScope,...t)}}function U(...e){return new Q("[Krunker Qoli]",...e)}const Me=U("[documentState]"),Ne=document.addEventListener.bind(document),Ue=document.removeEventListener.bind(document),[le,J]=b(!1);document.readyState!=="complete"?Ne("readystatechange",function e(){document.readyState==="complete"&&(Ue("readystatechange",e),Me.log("document readyState complete event received, setting state true"),J(!0))}):J(!0);const[We,Be]=b(!1),[He,Ge]=b(!1),m={getElementById:document.getElementById.bind(document),getElementsByClassName:document.getElementsByClassName.bind(document),getElementsByTagName:document.getElementsByTagName.bind(document),addEventListener:document.addEventListener.bind(document),removeEventListener:document.removeEventListener.bind(document),createEvent:document.createEvent.bind(document),hasFocus:document.hasFocus.bind(document)};class Ve extends MutationObserver{constructor(){super(...arguments),this.observe=MutationObserver.prototype.observe}}function je(e){return new Ve(t=>{t.forEach(n=>{n.type==="attributes"&&n.attributeName==="style"&&e(n.target.style)})})}function $(e){return je(t=>{const n=t.display==="block";e(n)})}const W={attributes:!0,attributeFilter:["style"]},B=U("[adPopupDismisser]"),[Z,ce]=b(!1);E(()=>{!We()||(B.log("isAdPopupActive effect",Z()),Z()&&m.getElementById("popupBack")?.click())});const _e=$(ce);function ze(){B.log("initAdPopupDismisser"),E(()=>{if(!le())return;B.log("document readyState complete, adding observer");const e=m.getElementById("popupHolder");e&&(ce(e.style.display==="block"),_e.observe(e,W))})}const k={open:window.open.bind(window),addEventListener:window.addEventListener.bind(window),removeEventListener:window.removeEventListener.bind(window)};function Qe(){const[e,t]=b(m.hasFocus()),n=()=>t(!0),s=()=>t(!1);return k.addEventListener("focus",n),k.addEventListener("blur",s),Ce(()=>{k.removeEventListener("focus",n),k.removeEventListener("blur",s)}),e}const $e={arrayFrom:Array.from.bind(Array)},q=MouseEvent,y=U("[fastRespawn]"),[ue,de]=b(!1),Ke=$(de);E(()=>{y.log("isUserInDeathWindow",ue())});const[fe,pe]=b(!1),Ye=$(pe);E(()=>{y.log("isUserInGame",fe())});const[ge,Xe]=b(!1);E(()=>{y.log("isPointerLocked",ge())});function Je(){y.log("trying to activate game");const e=$e.arrayFrom(m.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new q("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new q("mouseup",{bubbles:!0,cancelable:!0}))}const Ze=Qe();E(()=>{!He()||!Ze()||ge()||fe()||!ue()||Je()});function qe(){y.log("initFastRespawn"),E(()=>{if(!le())return;y.log("document readyState complete, adding observer");const e=m.getElementById("inGameUI");e&&(pe(e.style.display==="block"),Ye.observe(e,W));const t=m.getElementById("killCardHolder");t&&(de(t.style.display==="block"),Ke.observe(t,W)),m.addEventListener("pointerlockchange",()=>{Xe(!!document.pointerLockElement)})})}const me=Symbol("Comlink.proxy"),et=Symbol("Comlink.endpoint"),tt=Symbol("Comlink.releaseProxy"),H=Symbol("Comlink.thrown"),he=e=>typeof e=="object"&&e!==null||typeof e=="function",nt={canHandle:e=>he(e)&&e[me],serialize(e){const{port1:t,port2:n}=new MessageChannel;return we(e,t),[n,[n]]},deserialize(e){return e.start(),ve(e)}},st={canHandle:e=>he(e)&&H in e,serialize({value:e}){let t;return e instanceof Error?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?Object.assign(new Error(e.value.message),e.value):e.value}},be=new Map([["proxy",nt],["throw",st]]);function we(e,t=self){t.addEventListener("message",function n(s){if(!s||!s.data)return;const{id:r,type:o,path:i}=Object.assign({path:[]},s.data),u=(s.data.argumentList||[]).map(w);let a;try{const d=i.slice(0,-1).reduce((p,L)=>p[L],e),h=i.reduce((p,L)=>p[L],e);switch(o){case"GET":a=h;break;case"SET":d[i.slice(-1)[0]]=w(s.data.value),a=!0;break;case"APPLY":a=h.apply(d,u);break;case"CONSTRUCT":{const p=new h(...u);a=Se(p)}break;case"ENDPOINT":{const{port1:p,port2:L}=new MessageChannel;we(e,L),a=it(p,[p])}break;case"RELEASE":a=void 0;break;default:return}}catch(d){a={value:d,[H]:0}}Promise.resolve(a).catch(d=>({value:d,[H]:0})).then(d=>{const[h,p]=K(d);t.postMessage(Object.assign(Object.assign({},h),{id:r}),p),o==="RELEASE"&&(t.removeEventListener("message",n),Ee(t))})}),t.start&&t.start()}function rt(e){return e.constructor.name==="MessagePort"}function Ee(e){rt(e)&&e.close()}function ve(e,t){return G(e,[],t)}function R(e){if(e)throw new Error("Proxy has been released and is not useable")}function G(e,t=[],n=function(){}){let s=!1;const r=new Proxy(n,{get(o,i){if(R(s),i===tt)return()=>v(e,{type:"RELEASE",path:t.map(u=>u.toString())}).then(()=>{Ee(e),s=!0});if(i==="then"){if(t.length===0)return{then:()=>r};const u=v(e,{type:"GET",path:t.map(a=>a.toString())}).then(w);return u.then.bind(u)}return G(e,[...t,i])},set(o,i,u){R(s);const[a,d]=K(u);return v(e,{type:"SET",path:[...t,i].map(h=>h.toString()),value:a},d).then(w)},apply(o,i,u){R(s);const a=t[t.length-1];if(a===et)return v(e,{type:"ENDPOINT"}).then(w);if(a==="bind")return G(e,t.slice(0,-1));const[d,h]=ee(u);return v(e,{type:"APPLY",path:t.map(p=>p.toString()),argumentList:d},h).then(w)},construct(o,i){R(s);const[u,a]=ee(i);return v(e,{type:"CONSTRUCT",path:t.map(d=>d.toString()),argumentList:u},a).then(w)}});return r}function ot(e){return Array.prototype.concat.apply([],e)}function ee(e){const t=e.map(K);return[t.map(n=>n[0]),ot(t.map(n=>n[1]))]}const ye=new WeakMap;function it(e,t){return ye.set(e,t),e}function Se(e){return Object.assign(e,{[me]:!0})}function at(e,t=self,n="*"){return{postMessage:(s,r)=>e.postMessage(s,n,r),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function K(e){for(const[t,n]of be)if(n.canHandle(e)){const[s,r]=n.serialize(e);return[{type:"HANDLER",name:t,value:s},r]}return[{type:"RAW",value:e},ye.get(e)||[]]}function w(e){switch(e.type){case"HANDLER":return be.get(e.name).deserialize(e.value);case"RAW":return e.value}}function v(e,t,n){return new Promise(s=>{const r=lt();e.addEventListener("message",function o(i){!i.data||!i.data.id||i.data.id!==r||(e.removeEventListener("message",o),s(i.data))}),e.start&&e.start(),e.postMessage(Object.assign({id:r},t),n)})}function lt(){return new Array(4).fill(0).map(()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16)).join("-")}const ct="0.4.0",ut=ct,P=U("[Settings window communication]");let C=null;const Le=new URL("https://woyken.github.io/krunker-qoli/#userScriptSettings"),O=[];window.addEventListener("message",e=>{e.origin===Le.origin&&e.stopImmediatePropagation(),O.filter(t=>t.type==="message").forEach(({listener:t})=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function dt(e){P.log("settingsUpdatedCallback",e),Ge(e.enabledFastRespawn),Be(e.enabledAdPopupRemoval)}let D;function V(){D=void 0,C&&(C.close(),C=null)}function ft(e,t){return new Promise((n,s)=>{setTimeout(()=>{s(new Error("Promise timed out"))},t),e.then(n,s)})}async function pt(){const e=k.open(Le.href,"settingsWindow","width=400,height=400");if(!e)throw alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new Error("Failed to open settings window");V(),C=e;const t=at(C,{addEventListener(r,o){O.push({type:r,listener:o})},removeEventListener(r,o){const i=O.findIndex(({type:u,listener:a})=>u===r&&a===o);i>=0&&O.splice(i,1)}},"*"),n=ve(t);return await new Promise(r=>{P.log("waiting for settings window");const o=setInterval(()=>{P.log("checking for settings window"),ft(n.ping,200).then(()=>{clearInterval(o),r()})},200)}).then(()=>{n.onUnloadPromise.then(()=>{P.log("settings window unloaded"),V()})}),P.log("settings window available"),n.registerCallback(ut,Se(dt)),n}async function gt(){return D||(D=pt()),D}window.addEventListener("beforeunload",()=>{V()});ze();qe();function N(){m.removeEventListener("click",N),m.removeEventListener("keydown",N),gt()}m.addEventListener("click",N);m.addEventListener("keydown",N);
