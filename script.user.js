
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.5.8
// @description  Krunker quality of life improvements
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

function _e(e,t,n){const s=t,o=Object.getOwnPropertyNames(s);for(let i=0;i<o.length;i+=1){const r=Object.getOwnPropertyDescriptor(s,o[i]);if(r){const c={...r};r.get&&(c.get=r.get.bind(n)),r.set&&(c.set=r.set.bind(n)),typeof r.value=="function"&&(c.value=r.value.bind(n)),(c.get||c.set||c.value)&&Object.defineProperty(e,o[i],c)}}}function _(e,t,n){let s=Object.getPrototypeOf(t);for(;s!=null;)_e(e,s,n),s=Object.getPrototypeOf(s)}const Y=new Map;function ye(e){if(Y.has(e))return Y.get(e);const t=Object.getPrototypeOf(e);let n;return t?n=Object.create(ye(t)):n=Object.create(null),Object.defineProperties(n,Object.getOwnPropertyDescriptors(e)),Y.set(e,n),n}function x(e,t){const n=Object.getOwnPropertyNames(t).filter(s=>!new Array("prototype").includes(s));for(let s=0;s<n.length;s+=1){const o=Object.getOwnPropertyDescriptor(t,n[s]);if(o){const i={...o};o.get&&(i.get=o.get.bind(t)),o.set&&(i.set=o.set.bind(t)),typeof o.value=="function"&&(i.value=o.value.bind(t)),(i.get||i.set||i.value)&&Object.defineProperty(e,n[s],i)}}}const ze=(e,t)=>class extends e{constructor(...n){super(...n),Object.setPrototypeOf(this,t)}};function L(e){const t=ze(e,ye(e.prototype));return x(t,e),t}const a=L(Array),ve=L(MessageChannel),Qe=Symbol.apply.bind(Symbol);function S(...e){return Qe(null,e)}x(S,Symbol);const k=L(Object),Xe=L(Map),z=L(Promise),M=L(Error),J=Object.create(null);x(J,Math);let ne=!1;Proxy.prototype||(ne=!0);ne&&(Proxy.prototype=Object.create(null));const Ee=L(Proxy);ne&&delete Proxy.prototype;new a;const Ye=(e,t)=>e===t;S("solid-proxy");S("solid-track");S("solid-dev-component");const K={equals:Ye};let Le=Pe;const U={},O=1,V=2,qe={owned:null,cleanups:null,context:null,owner:null};var y=null;let T=null,w=null,W=null,m=null,C=null,se=0;function p(e,t){t=t?k.assign({},K,t):K;const n={value:e,observers:null,observerSlots:null,pending:U,comparator:t.equals||void 0},s=o=>(typeof o=="function"&&(o=o(n.pending!==U?n.pending:n.value)),oe(n,o));return new a(Se.bind(n),s)}function Je(e,t,n){const s=re(e,t,!0,O);N(s)}function g(e,t,n){Le=ot;const s=re(e,t,!1,O);s.user=!0,C?C.push(s):N(s)}function de(e,t,n){n=n?k.assign({},K,n):K;const s=re(e,t,!0,0);return s.pending=U,s.observers=null,s.observerSlots=null,s.comparator=n.equals||void 0,N(s),Se.bind(s)}function Ze(e){if(W)return e();let t;const n=W=new a;try{t=e()}finally{W=null}return ke(()=>{for(let s=0;s<n.length;s+=1){const o=n[s];if(o.pending!==U){const i=o.pending;o.pending=U,oe(o,i)}}},!1),t}function Ce(e){let t,n=w;return w=null,t=e(),w=n,t}function E(e){return y===null||(y.cleanups===null?y.cleanups=new a(e):y.cleanups.push(e)),e}function et(e){const t=S("context");return{id:t,Provider:rt(t),defaultValue:e}}function tt(e){const t=de(e);return de(()=>Z(t()))}function Se(){const e=T;if(this.sources&&(this.state||e)){const t=m;m=null,this.state===O||e?N(this):$(this),m=t}if(w){const t=this.observers?this.observers.length:0;w.sources?(w.sources.push(this),w.sourceSlots.push(t)):(w.sources=new a(this),w.sourceSlots=new a(t)),this.observers?(this.observers.push(w),this.observerSlots.push(w.sources.length-1)):(this.observers=new a(w),this.observerSlots=new a(w.sources.length-1))}return this.value}function oe(e,t,n){if(W)return e.pending===U&&W.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let s=!1;return e.value=t,e.observers&&e.observers.length&&ke(()=>{for(let o=0;o<e.observers.length;o+=1){const i=e.observers[o];s&&T.disposed.has(i),(s&&!i.tState||!s&&!i.state)&&(i.pure?m.push(i):C.push(i),i.observers&&Ie(i)),s||(i.state=O)}if(m.length>1e6)throw m=new a,new M},!1),t}function N(e){if(!e.fn)return;Oe(e);const t=y,n=w,s=se;w=y=e,nt(e,e.value,s),w=n,y=t}function nt(e,t,n){let s;try{s=e.fn(t)}catch(o){Ae(o)}(!e.updatedAt||e.updatedAt<=n)&&(e.observers&&e.observers.length?oe(e,s):e.value=s,e.updatedAt=n)}function re(e,t,n,s=O,o){const i={fn:e,state:s,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:y,context:null,pure:n};return y===null||y!==qe&&(y.owned?y.owned.push(i):y.owned=new a(i)),i}function F(e){const t=T;if(e.state===0||t)return;if(e.state===V||t)return $(e);if(e.suspense&&Ce(e.suspense.inFallback))return e.suspense.effects.push(e);const n=new a(e);for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<se);)(e.state||t)&&n.push(e);for(let s=n.length-1;s>=0;s--)if(e=n[s],e.state===O||t)N(e);else if(e.state===V||t){const o=m;m=null,$(e,n[0]),m=o}}function ke(e,t){if(m)return e();let n=!1;t||(m=new a),C?n=!0:C=new a,se++;try{const s=e();return st(n),s}catch(s){Ae(s)}finally{m=null,n||(C=null)}}function st(e){m&&(Pe(m),m=null),!e&&(C.length?Ze(()=>{Le(C),C=null}):C=null)}function Pe(e){for(let t=0;t<e.length;t++)F(e[t])}function ot(e){let t,n=0;for(t=0;t<e.length;t++){const o=e[t];o.user?e[n++]=o:F(o)}const s=e.length;for(t=0;t<n;t++)F(e[t]);for(t=s;t<e.length;t++)F(e[t])}function $(e,t){const n=T;e.state=0;for(let s=0;s<e.sources.length;s+=1){const o=e.sources[s];o.sources&&(o.state===O||n?o!==t&&F(o):(o.state===V||n)&&$(o,t))}}function Ie(e){const t=T;for(let n=0;n<e.observers.length;n+=1){const s=e.observers[n];(!s.state||t)&&(s.state=V,s.pure?m.push(s):C.push(s),s.observers&&Ie(s))}}function Oe(e){let t;if(e.sources)for(;e.sources.length;){const n=e.sources.pop(),s=e.sourceSlots.pop(),o=n.observers;if(o&&o.length){const i=o.pop(),r=n.observerSlots.pop();s<o.length&&(i.sourceSlots[r]=s,o[s]=i,n.observerSlots[s]=r)}}if(e.owned){for(t=0;t<e.owned.length;t++)Oe(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function Ae(e){throw e}function Z(e){if(typeof e=="function"&&!e.length)return Z(e());if(a.isArray(e)){const t=new a;for(let n=0;n<e.length;n++){const s=Z(e[n]);a.isArray(s)?t.push.apply(t,s):t.push(s)}return t}return e}function rt(e){return function(n){let s;return Je(()=>s=Ce(()=>(y.context={[e]:n.value},tt(()=>n.children)))),s}}S("fallback");et();const f={};_(f,document,document);const ie={};_(ie,console,console);x(ie,console);class ae{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new ae(...this.argsScope,...t)}log(...t){ie.log(...this.argsScope,...t)}}function A(...e){return new ae("[Krunker Qoli]",...e)}const it=A("[documentState]"),[B,pe]=p(!1);f.readyState!=="complete"?f.addEventListener("readystatechange",function e(){f.readyState==="complete"&&(f.removeEventListener("readystatechange",e),it.log("document readyState complete event received, setting state true"),pe(!0))}):pe(!0);function at(){const[e,t]=p(f.readyState),n=()=>f.readyState==="loading",s=()=>f.readyState==="interactive",o=()=>f.readyState==="complete",[i,r]=p(n()||s()||o()),[c,l]=p(s()||o()),[u,h]=p(o());return f.addEventListener("readystatechange",function b(){t(f.readyState),r(n()||s()||o()),l(s()||o()),h(o()),o()&&f.removeEventListener("readystatechange",b)}),{documentReadyState:e,isDocumentAtLeastLoading:i,isDocumentAtLeastInteractive:c,isDocumentAtLeastComplete:u}}const[Zt,ct]=p(!1),[lt,ut]=p(!1),[Re,ft]=p(!1),[dt,pt]=p(!1),gt=L(MutationObserver);function wt(e){return new gt(t=>{t.forEach(n=>{n.type==="attributes"&&n.attributeName==="style"&&e(n.target.style)})})}function Q(e){return wt(t=>{const n=t.display==="block";e(n)})}const X={attributes:!0,attributeFilter:new a("style")},q=A("[adPopupDismisser]");function mt(){q.log("initAdPopupDismisser");const[e,t]=p(!1),n=Q(t);g(()=>{if(!B())return;q.log("document readyState complete, adding observer");const s=f.getElementById("popupHolder");s&&(t(s.style.display==="block"),n.observe(s,X),E(n.disconnect.bind(n)))}),g(()=>{!lt()||(q.log("isAdPopupActive effect",e()),e()&&f.getElementById("popupBack")?.click())})}const ge=L(KeyboardEvent);function Me(){const[e,t]=p(!1),n=Q(t);return g(()=>{if(!B())return;const s=f.getElementById("inGameUI");s&&(t(s.style.display==="block"),n.observe(s,X),E(n.disconnect.bind(n)))}),e}const G=A("[autoReload]");function ht(){G.log("initAutoReload");const e=Me(),[t,n]=p(!1),s=Q(n);g(()=>{if(!B())return;G.log("document readyState complete, adding observer");const r=f.getElementById("reloadMsg");r&&(n(r.style.display==="block"),s.observe(r,X),E(s.disconnect.bind(s)))});const[o,i]=p(!1);g(()=>{if(!Re()||!t())return;G.log("pressing down reload button");const r=a.from(f.getElementsByTagName("canvas")).pop(),c={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new ge("keydown",c)),i(!0)}),g(()=>{if(!o()||!e()||t())return;G.log("releasing reload button");const r=a.from(f.getElementsByTagName("canvas")).pop(),c={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new ge("keyup",c))})}const we=L(MouseEvent),d={location:{}};_(d,window,window);_(d.location,window.location,window.location);x(d.location,window.location);x(d,window);function bt(){const[e,t]=p(f.hasFocus()),n=()=>t(!0),s=()=>t(!1);return d.addEventListener("focus",n),d.addEventListener("blur",s),E(()=>{d.removeEventListener("focus",n),d.removeEventListener("blur",s)}),e}function yt(){const[e,t]=p(!1);function n(){t(!!f.pointerLockElement)}return g(()=>{!B()||(f.addEventListener("pointerlockchange",n),E(()=>{f.removeEventListener("pointerlockchange",n)}))}),e}function vt(){const[e,t]=p(!1),n=Q(t);return g(()=>{if(!B())return;const s=f.getElementById("killCardHolder");s&&(t(s.style.display==="block"),n.observe(s,X),E(n.disconnect.bind(n)))}),e}let Ue=()=>({events:{},emit(e,...t){let n=this.events[e]||new a;for(let s=0,o=n.length;s<o;s++)n[s](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=new a(t)),()=>{this.events[e]=this.events[e]?.filter(n=>t!==n)}}});function xe(e){return{on:e.on.bind(e)}}const Et=Function.prototype.apply.apply.bind(Function.prototype.apply);function Lt(e){return typeof e!="object"||e==null?!1:"stack"in e}function ce(e,t,n){const s=A("[createFunctionProxy]",e,t,n);return s.log("creating function proxy"),new Ee(e,{apply(o,i,r){const c=s.createScopedLogger("[apply]",o,i,r);try{t?.(...r)}catch(u){c.log("beforeCallback error",u)}let l;try{l=Et(o,new a(i,r))}catch(u){throw c.log("EXCEPTION",u),Lt(u)&&(u.stack.includes("Object.apply")?u.stack=u.stack.replace(/\n.*Object\.apply.*/,""):u.stack.includes("apply@")&&(u.stack=u.stack.replace(/.*apply@.*\n/,""))),c.log("EXCEPTION before rethrow",u),u}try{n?.(l,...r)}catch(u){c.log("afterCallback error",u)}return l}})}const De=Ue(),Ct=document.exitPointerLock;document.exitPointerLock=ce(Ct,void 0,()=>De.emit("calledExitPointerLock"));var St=xe(De);const We=A("[fastRespawn]");function kt(){We.log("trying to activate game");const e=a.from(f.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new we("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new we("mouseup",{bubbles:!0,cancelable:!0}))}function Pt(){We.log("initFastRespawn");const e=vt(),t=Me(),n=yt(),s=bt(),[o,i]=p(!1),r=St.on("calledExitPointerLock",()=>{n()&&i(!0)});E(()=>{r()}),g(()=>{n()&&i(!1)}),g(()=>{!Re()||!s()||!o()||n()||t()||!e()||(i(!1),kt())})}const le=L(URL),It=L(WeakMap),Ot=L(Number),Fe=S("Comlink.proxy"),At=S("Comlink.endpoint"),Rt=S("Comlink.releaseProxy"),ee=S("Comlink.thrown"),Te=e=>typeof e=="object"&&e!==null||typeof e=="function",Mt={canHandle:e=>Te(e)&&e[Fe],serialize(e){const{port1:t,port2:n}=new ve;return Be(e,t),new a(n,new a(n))},deserialize(e){return e.start(),Ge(e)}},Ut={canHandle:e=>Te(e)&&ee in e,serialize({value:e}){let t;return e instanceof M?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},new a(t,new a)},deserialize(e){throw e.isError?k.assign(new M(e.value.message),e.value):e.value}},Ne=new Xe(new a(new a("proxy",Mt),new a("throw",Ut)));function Be(e,t=self){t.addEventListener("message",function n(s){if(!s||!s.data)return;const{id:o,type:i,path:r}=k.assign({path:new a},s.data),c=(s.data.argumentList||new a).map(I);let l;try{const u=r.slice(0,-1).reduce((b,D)=>b[D],e),h=r.reduce((b,D)=>b[D],e);switch(i){case"GET":l=h;break;case"SET":u[r.slice(-1)[0]]=I(s.data.value),l=!0;break;case"APPLY":l=h.apply(u,c);break;case"CONSTRUCT":{const b=new h(...c);l=Ke(b)}break;case"ENDPOINT":{const{port1:b,port2:D}=new ve;Be(e,D),l=Wt(b,new a(b))}break;case"RELEASE":l=void 0;break;default:return}}catch(u){l={value:u,[ee]:0}}z.resolve(l).catch(u=>({value:u,[ee]:0})).then(u=>{const[h,b]=ue(u);t.postMessage(k.assign(k.assign({},h),{id:o}),b),i==="RELEASE"&&(t.removeEventListener("message",n),He(t))})}),t.start&&t.start()}function xt(e){return e.constructor.name==="MessagePort"}function He(e){xt(e)&&e.close()}function Ge(e,t){return te(e,new a,t)}function j(e){if(e)throw new M("Proxy has been released and is not useable")}function te(e,t=new a,n=function(){}){let s=!1;const o=new Ee(n,{get(i,r){if(j(s),r===Rt)return()=>R(e,{type:"RELEASE",path:t.map(c=>c.toString())}).then(()=>{He(e),s=!0});if(r==="then"){if(t.length===0)return{then:()=>o};const c=R(e,{type:"GET",path:t.map(l=>l.toString())}).then(I);return c.then.bind(c)}return te(e,new a(...t,r))},set(i,r,c){j(s);const[l,u]=ue(c);return R(e,{type:"SET",path:new a(...t,r).map(h=>h.toString()),value:l},u).then(I)},apply(i,r,c){j(s);const l=t[t.length-1];if(l===At)return R(e,{type:"ENDPOINT"}).then(I);if(l==="bind")return te(e,t.slice(0,-1));const[u,h]=me(c);return R(e,{type:"APPLY",path:t.map(b=>b.toString()),argumentList:u},h).then(I)},construct(i,r){j(s);const[c,l]=me(r);return R(e,{type:"CONSTRUCT",path:t.map(u=>u.toString()),argumentList:c},l).then(I)}});return o}function Dt(e){return a.prototype.concat.apply(new a,e)}function me(e){const t=e.map(ue);return new a(t.map(n=>n[0]),Dt(t.map(n=>n[1])))}const je=new It;function Wt(e,t){return je.set(e,t),e}function Ke(e){return k.assign(e,{[Fe]:!0})}function Ft(e,t=self,n="*"){return{postMessage:(s,o)=>e.postMessage(s,n,o),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function ue(e){for(const[t,n]of Ne)if(n.canHandle(e)){const[s,o]=n.serialize(e);return new a({type:"HANDLER",name:t,value:s},o)}return new a({type:"RAW",value:e},je.get(e)||new a)}function I(e){switch(e.type){case"HANDLER":return Ne.get(e.name).deserialize(e.value);case"RAW":return e.value}}function R(e,t,n){return new z(s=>{const o=Tt();e.addEventListener("message",function i(r){!r.data||!r.data.id||r.data.id!==o||(e.removeEventListener("message",i),s(r.data))}),e.start&&e.start(),e.postMessage(k.assign({id:o},t),n)})}function Tt(){return new a(4).fill(0).map(()=>J.floor(J.random()*Ot.MAX_SAFE_INTEGER).toString(16)).join("-")}const Nt="0.5.8",Bt=Nt;function Ht(...e){const t=Ft(...e),n={},s=t.addEventListener.bind(t);t.addEventListener=(...r)=>{const c=n[r[0]];return c?c.push(r[1]):n[r[0]]=new a(r[1]),s(...r)};const o=t.removeEventListener.bind(t);t.removeEventListener=(...r)=>{const c=n[r[0]];return c&&(n[r[0]]=c.filter(l=>l!==r[1])),o(...r)};function i(){k.keys(n).forEach(r=>{n[r].forEach(c=>{o(r,c)})})}return{unsubscribeAll:i,...t}}const Gt=A("[useRemoveClosedWindows]");function jt(e,t){const n=setInterval(()=>{const s=e();s&&s.closed&&(Gt.log("is closed",e()),t())},1e3);E(()=>clearInterval(n))}const H=Ue(),Kt=window.history.pushState;window.history.pushState=ce(Kt,void 0,()=>H.emit("locationChanged"));const Vt=window.history.replaceState;window.history.replaceState=ce(Vt,void 0,()=>H.emit("locationChanged"));window.addEventListener("hashchange",()=>H.emit("locationChanged"));window.addEventListener("popstate",()=>H.emit("locationChanged"));var $t=xe(H);function Ve(){const[e,t]=p(d.location.href);return $t.on("locationChanged",()=>{t(d.location.href)}),e}const v=A("[Settings window communication]"),$e=le,fe=new $e("https://woyken.github.io/krunker-qoli"),P={};d.addEventListener("message",e=>{e.origin===fe.origin&&e.stopImmediatePropagation(),P.message?.forEach(t=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function _t(e){v.log("settingsUpdatedCallback",e),ft(e.enabledFastRespawn),ut(e.enabledAdPopupRemoval),ct(e.enabledAutoReload),pt(e.enabledWindowManager)}function he(e,t){return new z((n,s)=>{setTimeout(()=>{s(new M("Promise timed out"))},t),e.then(n,s)})}let be=!1;function zt(){const[e,t]=p();if(d.opener)t(d.opener);else{const{isDocumentAtLeastInteractive:n}=at();g(()=>{if(be||!n())return;v.log("opening new settings window");const s=d.open(new $e("#userScriptSettings",fe).href,"settingsWindow","width=400,height=450");if(be=!0,!s)throw d.alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new M("Failed to open settings window");t(s),E(()=>{v.log("onCleanup, closing settings window",s),s.close()});function o(){v.log("handleBeforeUnload, closing settings window",s),s?.close()}d.addEventListener("beforeunload",o),E(()=>d.removeEventListener("beforeunload",o)),jt(e,t)})}return e}async function Qt(e){const[t,n]=p("connecting");E(()=>n("disposed"));const s=Ht(e,{addEventListener(l,u){P[l]?P[l].push(u):P[l]=new a(u)},removeEventListener(l,u){P[l]&&(P[l]=P[l].filter(h=>h!==u))}},"*"),o=Ge(s);E(()=>s.unsubscribeAll());function i(){o.scriptUnloading().catch(l=>v.log("on beforeUnload error",l))}d.addEventListener("beforeunload",i),E(()=>d.removeEventListener("beforeunload",i));const r=Ve();g(()=>{o.scriptLocationChanged(r())});const c=new z(l=>{v.log("waiting for settings window");const u=setInterval(()=>{v.log("checking for settings window"),he(o.ping,200).then(()=>{clearInterval(u),l()}).catch(h=>{v.log("[onSettingsWindowAvailablePromise]","error",h)})},200)});return he(c,6e4).then(()=>{o.onUnloadPromise.then(()=>{v.log("settings window unloaded"),n("disposed")}),v.log("settings window available"),n("available")}).catch(l=>{v.log("settings window connection error",l),n("error")}),g(()=>{v.log("settings connection state changed",t()),t()==="available"&&(v.log("registering for remote settings callbacks"),o.registerSettingsCallback(Bt,Ke(_t)))}),{state:t,remoteExposedSettings:o}}function Xt(){const e=zt(),[t,n]=p();return g(()=>{const s=e();if(!s)return;const o=Qt(s);n(o)}),t}function Yt(){g(()=>{if(!dt()||d.opener)return;const e=d.location.href,t=new le(`#windowManager?redirectKrunkerUrl=${e}`,fe);d.open(t,"_self")})}function qt(){const[e,t]=p(!1),n=Ve();return g(()=>new le(n()).pathname==="/"?t(!0):t(!1)),e}function Jt(){const e=qt();g(()=>{!e()||(mt(),Pt(),ht(),Yt(),Xt())})}Jt();
