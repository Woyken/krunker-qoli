
// ==UserScript==
// @name         Krunker Quoli
// @namespace    https://github.com/Woyken/krunker-qoli
// @version      0.5.6
// @description  
// @author       Woyken
// @match        https://krunker.io/*
// @grant        none
// @run-at       document-start
// @downloadURL  https://woyken.github.io/krunker-qoli/script.user.js
// ==/UserScript==
/**/

function ze(e,t,o){const n=t,s=Object.getOwnPropertyNames(n);for(let i=0;i<s.length;i+=1){const r=Object.getOwnPropertyDescriptor(n,s[i]);r&&typeof r.value=="function"&&Object.defineProperty(e,s[i],{...r,value:r.value.bind(o)})}}function X(e,t,o){let n=Object.getPrototypeOf(t);for(;n!=null;)ze(e,n,o),n=Object.getPrototypeOf(n)}function S(e,t){const o=t,n=Object.getOwnPropertyNames(o);for(let s=0;s<n.length;s+=1){const i=Object.getOwnPropertyDescriptor(o,n[s]);i&&Object.defineProperty(e.prototype,n[s],i)}}function C(e,t){const o=Object.getOwnPropertyNames(t);for(let n=0;n<o.length;n+=1){const s=Object.getOwnPropertyDescriptor(t,o[n]);s&&typeof s.value=="function"&&Object.defineProperty(e,o[n],{...s,value:s.value.bind(t)})}}class se extends MessageChannel{}S(se,MessageChannel.prototype);const Qe=Symbol;function U(e){return Qe(e)}C(U,Symbol);S(U,Symbol.prototype);class P extends Object{}C(P,Object);S(P,Object.prototype);class Le extends Map{}S(Le,Map.prototype);class x extends Array{}C(x,Array);S(x,Array.prototype);class T extends Promise{}C(T,Promise);S(T,Promise.prototype);class O extends Error{}S(O,Error.prototype);const Z=Object.create(null);C(Z,Math);const Xe=Proxy;function re(e,t){return new Xe(e,t)}re.revocable=Proxy.revocable.bind(Proxy);const Ye=(e,t)=>e===t,me={equals:Ye};let Se=Ce;const B={},D=1,_=2,qe={owned:null,cleanups:null,context:null,owner:null};var E=null;let H=null,m=null,N=null,h=null,k=null,ie=0;function f(e,t){t=t?P.assign({},me,t):me;const o={value:e,observers:null,observerSlots:null,pending:B,comparator:t.equals||void 0},n=s=>(typeof s=="function"&&(s=s(o.pending!==B?o.pending:o.value)),ae(o,s));return[et.bind(o),n]}function g(e,t,o){Se=st;const n=nt(e,t,!1,D);n.user=!0,k?k.push(n):ce(n)}function Je(e){if(N)return e();let t;const o=N=[];try{t=e()}finally{N=null}return ke(()=>{for(let n=0;n<o.length;n+=1){const s=o[n];if(s.pending!==B){const i=s.pending;s.pending=B,ae(s,i)}}},!1),t}function Ze(e){let t,o=m;return m=null,t=e(),m=o,t}function L(e){return E===null||(E.cleanups===null?E.cleanups=[e]:E.cleanups.push(e)),e}function et(){const e=H;if(this.sources&&(this.state||e)){const t=h;h=null,this.state===D||e?ce(this):z(this),h=t}if(m){const t=this.observers?this.observers.length:0;m.sources?(m.sources.push(this),m.sourceSlots.push(t)):(m.sources=[this],m.sourceSlots=[t]),this.observers?(this.observers.push(m),this.observerSlots.push(m.sources.length-1)):(this.observers=[m],this.observerSlots=[m.sources.length-1])}return this.value}function ae(e,t,o){if(N)return e.pending===B&&N.push(e),e.pending=t,t;if(e.comparator&&e.comparator(e.value,t))return t;let n=!1;return e.value=t,e.observers&&e.observers.length&&ke(()=>{for(let s=0;s<e.observers.length;s+=1){const i=e.observers[s];n&&H.disposed.has(i),(n&&!i.tState||!n&&!i.state)&&(i.pure?h.push(i):k.push(i),i.observers&&Pe(i)),n||(i.state=D)}if(h.length>1e6)throw h=[],new O},!1),t}function ce(e){if(!e.fn)return;Ie(e);const t=E,o=m,n=ie;m=E=e,tt(e,e.value,n),m=o,E=t}function tt(e,t,o){let n;try{n=e.fn(t)}catch(s){Re(s)}(!e.updatedAt||e.updatedAt<=o)&&(e.observers&&e.observers.length?ae(e,n):e.value=n,e.updatedAt=o)}function nt(e,t,o,n=D,s){const i={fn:e,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:E,context:null,pure:o};return E===null||E!==qe&&(E.owned?E.owned.push(i):E.owned=[i]),i}function W(e){const t=H;if(e.state===0||t)return;if(e.state===_||t)return z(e);if(e.suspense&&Ze(e.suspense.inFallback))return e.suspense.effects.push(e);const o=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<ie);)(e.state||t)&&o.push(e);for(let n=o.length-1;n>=0;n--)if(e=o[n],e.state===D||t)ce(e);else if(e.state===_||t){const s=h;h=null,z(e,o[0]),h=s}}function ke(e,t){if(h)return e();let o=!1;t||(h=[]),k?o=!0:k=[],ie++;try{const n=e();return ot(o),n}catch(n){Re(n)}finally{h=null,o||(k=null)}}function ot(e){h&&(Ce(h),h=null),!e&&(k.length?Je(()=>{Se(k),k=null}):k=null)}function Ce(e){for(let t=0;t<e.length;t++)W(e[t])}function st(e){let t,o=0;for(t=0;t<e.length;t++){const s=e[t];s.user?e[o++]=s:W(s)}const n=e.length;for(t=0;t<o;t++)W(e[t]);for(t=n;t<e.length;t++)W(e[t])}function z(e,t){const o=H;e.state=0;for(let n=0;n<e.sources.length;n+=1){const s=e.sources[n];s.sources&&(s.state===D||o?s!==t&&W(s):(s.state===_||o)&&z(s,t))}}function Pe(e){const t=H;for(let o=0;o<e.observers.length;o+=1){const n=e.observers[o];(!n.state||t)&&(n.state=_,n.pure?h.push(n):k.push(n),n.observers&&Pe(n))}}function Ie(e){let t;if(e.sources)for(;e.sources.length;){const o=e.sources.pop(),n=e.sourceSlots.pop(),s=o.observers;if(s&&s.length){const i=s.pop(),r=o.observerSlots.pop();n<s.length&&(i.sourceSlots[r]=n,s[n]=i,o.observerSlots[n]=r)}}if(e.owned){for(t=0;t<e.owned.length;t++)Ie(e.owned[t]);e.owned=null}if(e.cleanups){for(t=0;t<e.cleanups.length;t++)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function Re(e){throw e}const d={get readyState(){return document.readyState},get pointerLockElement(){return document.pointerLockElement}};X(d,document,document);const y={getElementById:d.getElementById.bind(d),getElementsByClassName:d.getElementsByClassName.bind(d),getElementsByTagName:d.getElementsByTagName.bind(d),addEventListener:d.addEventListener.bind(d),removeEventListener:d.removeEventListener.bind(d),createEvent:d.createEvent.bind(d),hasFocus:d.hasFocus.bind(d)},Q={};X(Q,console,console);C(Q,console);const rt=Q.log.bind(Q);class le{constructor(...t){this.argsScope=t}createScopedLogger(...t){return new le(...this.argsScope,...t)}log(...t){rt(...this.argsScope,...t)}}function A(...e){return new le("[Krunker Qoli]",...e)}const it=A("[documentState]"),[G,he]=f(!1);d.readyState!=="complete"?y.addEventListener("readystatechange",function e(){d.readyState==="complete"&&(y.removeEventListener("readystatechange",e),it.log("document readyState complete event received, setting state true"),he(!0))}):he(!0);function at(){const[e,t]=f(d.readyState),o=()=>d.readyState==="loading",n=()=>d.readyState==="interactive",s=()=>d.readyState==="complete",[i,r]=f(o()||n()||s()),[l,a]=f(n()||s()),[c,b]=f(s());return y.addEventListener("readystatechange",function w(){t(d.readyState),r(o()||n()||s()),a(n()||s()),b(s()),s()&&y.removeEventListener("readystatechange",w)}),{documentReadyState:e,isDocumentAtLeastLoading:i,isDocumentAtLeastInteractive:l,isDocumentAtLeastComplete:c}}const[Jt,ct]=f(!1),[lt,ut]=f(!1),[Oe,dt]=f(!1),[ft,pt]=f(!1);class ee extends MutationObserver{}S(ee,MutationObserver.prototype);class gt extends ee{constructor(){super(...arguments),this.observe=ee.prototype.observe}}function mt(e){return new gt(t=>{t.forEach(o=>{o.type==="attributes"&&o.attributeName==="style"&&e(o.target.style)})})}function Y(e){return mt(t=>{const o=t.display==="block";e(o)})}const q={attributes:!0,attributeFilter:["style"]},J=A("[adPopupDismisser]");function ht(){J.log("initAdPopupDismisser");const[e,t]=f(!1),o=Y(t);g(()=>{if(!G())return;J.log("document readyState complete, adding observer");const n=y.getElementById("popupHolder");n&&(t(n.style.display==="block"),o.observe(n,q),L(o.disconnect.bind(o)))}),g(()=>{!lt()||(J.log("isAdPopupActive effect",e()),e()&&y.getElementById("popupBack")?.click())})}class Ae extends KeyboardEvent{}S(Ae,KeyboardEvent.prototype);function Me(){const[e,t]=f(!1),o=Y(t);return g(()=>{if(!G())return;const n=y.getElementById("inGameUI");n&&(t(n.style.display==="block"),o.observe(n,q),L(o.disconnect.bind(o)))}),e}const te={arrayFrom:x.from.bind(x)},be=Ae,V=A("[autoReload]");function bt(){V.log("initAutoReload");const e=Me(),[t,o]=f(!1),n=Y(o);g(()=>{if(!G())return;V.log("document readyState complete, adding observer");const r=y.getElementById("reloadMsg");r&&(o(r.style.display==="block"),n.observe(r,q),L(n.disconnect.bind(n)))});const[s,i]=f(!1);g(()=>{if(!Oe()||!t())return;V.log("pressing down reload button");const r=te.arrayFrom(y.getElementsByTagName("canvas")).pop(),l={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new be("keydown",l)),i(!0)}),g(()=>{if(!s()||!e()||t())return;V.log("releasing reload button");const r=te.arrayFrom(y.getElementsByTagName("canvas")).pop(),l={code:"KeyR",composed:!0,key:"r",keyCode:82,which:82,bubbles:!0,cancelable:!0};r?.dispatchEvent(new be("keyup",l))})}class xe extends MouseEvent{}S(xe,MouseEvent.prototype);const u={opener:window.opener,location:{get href(){return window.location.href},set href(e){window.location.href=e}}};X(u,window,window);X(u.location,window.location,window.location);C(u.location,window.location);C(u,window);const yt=u.location,p={open:u.open.bind(u),addEventListener:u.addEventListener.bind(u),removeEventListener:u.removeEventListener.bind(u),setTimeout:u.setTimeout.bind(u),clearTimeout:u.clearTimeout.bind(u),opener:u.opener,location:{get href(){return yt.href},assign:u.location.assign.bind(u.location),reload:u.location.reload.bind(u.location),replace:u.location.replace.bind(u.location),toString:u.location.toString.bind(u.location)}};function wt(){const[e,t]=f(y.hasFocus()),o=()=>t(!0),n=()=>t(!1);return p.addEventListener("focus",o),p.addEventListener("blur",n),L(()=>{p.removeEventListener("focus",o),p.removeEventListener("blur",n)}),e}function vt(){const[e,t]=f(!1);function o(){t(!!d.pointerLockElement)}return g(()=>{!G()||(y.addEventListener("pointerlockchange",o),L(()=>{y.removeEventListener("pointerlockchange",o)}))}),e}function Et(){const[e,t]=f(!1),o=Y(t);return g(()=>{if(!G())return;const n=y.getElementById("killCardHolder");n&&(t(n.style.display==="block"),o.observe(n,q),L(o.disconnect.bind(o)))}),e}let Ue=()=>({events:{},emit(e,...t){let o=this.events[e]||[];for(let n=0,s=o.length;n<s;n++)o[n](...t)},on(e,t){return this.events[e]?.push(t)||(this.events[e]=[t]),()=>{this.events[e]=this.events[e]?.filter(o=>t!==o)}}});function Te(e){return{on:e.on.bind(e)}}const Lt=Function.prototype.apply.apply.bind(Function.prototype.apply);function St(e){return typeof e!="object"||e==null?!1:"stack"in e}function ue(e,t,o){const n=A("[createFunctionProxy]",e,t,o);return n.log("creating function proxy"),new re(e,{apply(s,i,r){const l=n.createScopedLogger("[apply]",s,i,r);try{t?.(...r)}catch(c){l.log("beforeCallback error",c)}let a;try{a=Lt(s,[i,r])}catch(c){throw l.log("EXCEPTION",c),St(c)&&(c.stack.includes("Object.apply")?c.stack=c.stack.replace(/\n.*Object\.apply.*/,""):c.stack.includes("apply@")&&(c.stack=c.stack.replace(/.*apply@.*\n/,""))),l.log("EXCEPTION before rethrow",c),c}try{o?.(...r)}catch(c){l.log("afterCallback error",c)}return a}})}const De=Ue(),kt=document.exitPointerLock;document.exitPointerLock=ue(kt,void 0,()=>De.emit("calledExitPointerLock"));var Ct=Te(De);const ye=xe,Fe=A("[fastRespawn]");function Pt(){Fe.log("trying to activate game");const e=te.arrayFrom(y.getElementsByTagName("canvas")).pop();e?.dispatchEvent(new ye("mousedown",{bubbles:!0,cancelable:!0})),e?.dispatchEvent(new ye("mouseup",{bubbles:!0,cancelable:!0}))}function It(){Fe.log("initFastRespawn");const e=Et(),t=Me(),o=vt(),n=wt(),[s,i]=f(!1),r=Ct.on("calledExitPointerLock",()=>{o()&&i(!0)});L(()=>{r()}),g(()=>{o()&&i(!1)}),g(()=>{!Oe()||!n()||!s()||o()||t()||!e()||(i(!1),Pt())})}class j extends URL{}C(j,URL);S(j,URL.prototype);class de extends WeakMap{}C(de,WeakMap);S(de,WeakMap.prototype);class fe extends Number{}C(fe,Number);S(fe,Number.prototype);const Ne=U("Comlink.proxy"),Rt=U("Comlink.endpoint"),Ot=U("Comlink.releaseProxy"),ne=U("Comlink.thrown"),We=e=>typeof e=="object"&&e!==null||typeof e=="function",At={canHandle:e=>We(e)&&e[Ne],serialize(e){const{port1:t,port2:o}=new se;return He(e,t),[o,[o]]},deserialize(e){return e.start(),je(e)}},Mt={canHandle:e=>We(e)&&ne in e,serialize({value:e}){let t;return e instanceof O?t={isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:t={isError:!1,value:e},[t,[]]},deserialize(e){throw e.isError?P.assign(new O(e.value.message),e.value):e.value}},Be=new Le([["proxy",At],["throw",Mt]]);function He(e,t=self){t.addEventListener("message",function o(n){if(!n||!n.data)return;const{id:s,type:i,path:r}=P.assign({path:[]},n.data),l=(n.data.argumentList||[]).map(R);let a;try{const c=r.slice(0,-1).reduce((w,F)=>w[F],e),b=r.reduce((w,F)=>w[F],e);switch(i){case"GET":a=b;break;case"SET":c[r.slice(-1)[0]]=R(n.data.value),a=!0;break;case"APPLY":a=b.apply(c,l);break;case"CONSTRUCT":{const w=new b(...l);a=Ve(w)}break;case"ENDPOINT":{const{port1:w,port2:F}=new se;He(e,F),a=Tt(w,[w])}break;case"RELEASE":a=void 0;break;default:return}}catch(c){a={value:c,[ne]:0}}T.resolve(a).catch(c=>({value:c,[ne]:0})).then(c=>{const[b,w]=pe(c);t.postMessage(P.assign(P.assign({},b),{id:s}),w),i==="RELEASE"&&(t.removeEventListener("message",o),Ge(t))})}),t.start&&t.start()}function xt(e){return e.constructor.name==="MessagePort"}function Ge(e){xt(e)&&e.close()}function je(e,t){return oe(e,[],t)}function $(e){if(e)throw new O("Proxy has been released and is not useable")}function oe(e,t=[],o=function(){}){let n=!1;const s=new re(o,{get(i,r){if($(n),r===Ot)return()=>M(e,{type:"RELEASE",path:t.map(l=>l.toString())}).then(()=>{Ge(e),n=!0});if(r==="then"){if(t.length===0)return{then:()=>s};const l=M(e,{type:"GET",path:t.map(a=>a.toString())}).then(R);return l.then.bind(l)}return oe(e,[...t,r])},set(i,r,l){$(n);const[a,c]=pe(l);return M(e,{type:"SET",path:[...t,r].map(b=>b.toString()),value:a},c).then(R)},apply(i,r,l){$(n);const a=t[t.length-1];if(a===Rt)return M(e,{type:"ENDPOINT"}).then(R);if(a==="bind")return oe(e,t.slice(0,-1));const[c,b]=we(l);return M(e,{type:"APPLY",path:t.map(w=>w.toString()),argumentList:c},b).then(R)},construct(i,r){$(n);const[l,a]=we(r);return M(e,{type:"CONSTRUCT",path:t.map(c=>c.toString()),argumentList:l},a).then(R)}});return s}function Ut(e){return x.prototype.concat.apply([],e)}function we(e){const t=e.map(pe);return[t.map(o=>o[0]),Ut(t.map(o=>o[1]))]}const Ke=new de;function Tt(e,t){return Ke.set(e,t),e}function Ve(e){return P.assign(e,{[Ne]:!0})}function Dt(e,t=self,o="*"){return{postMessage:(n,s)=>e.postMessage(n,o,s),addEventListener:t.addEventListener.bind(t),removeEventListener:t.removeEventListener.bind(t)}}function pe(e){for(const[t,o]of Be)if(o.canHandle(e)){const[n,s]=o.serialize(e);return[{type:"HANDLER",name:t,value:n},s]}return[{type:"RAW",value:e},Ke.get(e)||[]]}function R(e){switch(e.type){case"HANDLER":return Be.get(e.name).deserialize(e.value);case"RAW":return e.value}}function M(e,t,o){return new T(n=>{const s=Ft();e.addEventListener("message",function i(r){!r.data||!r.data.id||r.data.id!==s||(e.removeEventListener("message",i),n(r.data))}),e.start&&e.start(),e.postMessage(P.assign({id:s},t),o)})}function Ft(){return new x(4).fill(0).map(()=>Z.floor(Z.random()*fe.MAX_SAFE_INTEGER).toString(16)).join("-")}const Nt="0.5.6",Wt=Nt;function Bt(...e){const t=Dt(...e),o={},n=t.addEventListener.bind(t);t.addEventListener=(...r)=>{const l=o[r[0]];return l?l.push(r[1]):o[r[0]]=[r[1]],n(...r)};const s=t.removeEventListener.bind(t);t.removeEventListener=(...r)=>{const l=o[r[0]];return l&&(o[r[0]]=l.filter(a=>a!==r[1])),s(...r)};function i(){P.keys(o).forEach(r=>{o[r].forEach(l=>{s(r,l)})})}return{unsubscribeAll:i,...t}}const Ht=A("[useRemoveClosedWindows]");function Gt(e,t){const o=setInterval(()=>{const n=e();n&&n.closed&&(Ht.log("is closed",e()),t())},1e3);L(()=>clearInterval(o))}const K=Ue(),jt=window.history.pushState;window.history.pushState=ue(jt,void 0,()=>K.emit("locationChanged"));const Kt=window.history.replaceState;window.history.replaceState=ue(Kt,void 0,()=>K.emit("locationChanged"));p.addEventListener("hashchange",()=>K.emit("locationChanged"));p.addEventListener("popstate",()=>K.emit("locationChanged"));var Vt=Te(K);function $e(){const[e,t]=f(p.location.href);return Vt.on("locationChanged",()=>{t(p.location.href)}),e}const v=A("[Settings window communication]"),_e=j,ge=new _e("https://woyken.github.io/krunker-qoli"),I={};p.addEventListener("message",e=>{e.origin===ge.origin&&e.stopImmediatePropagation(),I.message?.forEach(t=>{"handleEvent"in t?t.handleEvent(e):t(e)})});function $t(e){v.log("settingsUpdatedCallback",e),dt(e.enabledFastRespawn),ut(e.enabledAdPopupRemoval),ct(e.enabledAutoReload),pt(e.enabledWindowManager)}function ve(e,t){return new T((o,n)=>{setTimeout(()=>{n(new O("Promise timed out"))},t),e.then(o,n)})}let Ee=!1;function _t(){const[e,t]=f();if(p.opener)t(p.opener);else{const{isDocumentAtLeastInteractive:o}=at();g(()=>{if(Ee||!o())return;v.log("opening new settings window");const n=p.open(new _e("#userScriptSettings",ge).href,"settingsWindow","width=400,height=450");if(Ee=!0,!n)throw alert("Failed to open settings window, allow popups for Krunker Qoli to work"),new O("Failed to open settings window");t(n),L(()=>{v.log("onCleanup, closing settings window",n),n.close()});function s(){v.log("handleBeforeUnload, closing settings window",n),n?.close()}p.addEventListener("beforeunload",s),L(()=>p.removeEventListener("beforeunload",s)),Gt(e,t)})}return e}async function zt(e){const[t,o]=f("connecting");L(()=>o("disposed"));const n=Bt(e,{addEventListener(a,c){I[a]?I[a].push(c):I[a]=[c]},removeEventListener(a,c){I[a]&&(I[a]=I[a].filter(b=>b!==c))}},"*"),s=je(n);L(()=>n.unsubscribeAll());function i(){s.scriptUnloading().catch(a=>v.log("on beforeUnload error",a))}p.addEventListener("beforeunload",i),L(()=>p.removeEventListener("beforeunload",i));const r=$e();g(()=>{s.scriptLocationChanged(r())});const l=new T(a=>{v.log("waiting for settings window");const c=setInterval(()=>{v.log("checking for settings window"),ve(s.ping,200).then(()=>{clearInterval(c),a()}).catch(b=>{v.log("[onSettingsWindowAvailablePromise]","error",b)})},200)});return ve(l,6e4).then(()=>{s.onUnloadPromise.then(()=>{v.log("settings window unloaded"),o("disposed")}),v.log("settings window available"),o("available")}).catch(a=>{v.log("settings window connection error",a),o("error")}),g(()=>{v.log("settings connection state changed",t()),t()==="available"&&(v.log("registering for remote settings callbacks"),s.registerSettingsCallback(Wt,Ve($t)))}),{state:t,remoteExposedSettings:s}}function Qt(){const e=_t(),[t,o]=f();return g(()=>{const n=e();if(!n)return;const s=zt(n);o(s)}),t}function Xt(){g(()=>{if(!ft()||p.opener)return;const e=p.location.href,t=new j(`#windowManager?redirectKrunkerUrl=${e}`,ge);p.open(t,"_self")})}function Yt(){const[e,t]=f(!1),o=$e();return g(()=>{new j(o()).searchParams.get("game")&&t(!0)}),e}function qt(){const e=Yt();g(()=>{!e()||(ht(),It(),bt(),Xt(),Qt())})}qt();
